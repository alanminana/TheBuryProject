@model TheBuryProject.ViewModels.VentaViewModel

@{
    ViewData["Title"] = "Detalles de Venta";
    var soloDocumentacionFaltante = Model.ValidacionCredito?.RequisitosPendientes?.Any() == true
        && Model.ValidacionCredito.RequisitosPendientes.All(r =>
            r.Tipo == TheBuryProject.ViewModels.TipoRequisitoPendiente.DocumentacionFaltante);
    var puedeAplicarExcepcionDocumental = User.TienePermiso("ventas", "authorize")
        && Model.TipoPago == TheBuryProject.Models.Enums.TipoPago.CreditoPersonal
        && soloDocumentacionFaltante;
}

@section Styles {
    <link rel="stylesheet" href="~/css/venta.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light venta-section">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                <div>
                    <h2 class="mb-1"><i class="bi bi-file-earmark-text text-info me-2" aria-hidden="true"></i> Detalles de Venta</h2>
                    <p class="mb-0 text-muted">Número <strong>@Model.Numero</strong> | Cliente: @Model.ClienteNombre</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i> Volver al Listado
                </a>
            </div>
        </div>

        <div class="col-12">
            @foreach (var tipo in new[] { "Success", "Warning", "Error" })
            {
                if (TempData[tipo] != null)
                {
                    var clase = tipo == "Success" ? "alert-success"
                               : tipo == "Warning" ? "alert-warning"
                               : "alert-danger";

                    <div class="alert @clase alert-dismissible fade show" role="alert">
                        <i class="bi @(tipo == "Success" ? "bi-check-circle" : tipo == "Warning" ? "bi-exclamation-triangle" : "bi-x-circle")" aria-hidden="true"></i>
                        @TempData[tipo]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                    </div>
                }
            }

            @if (TempData["Info"] != null)
            {
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle" aria-hidden="true"></i>
                    @TempData["Info"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>
            }

            @if (Model.TieneExcepcionDocumentalRegistrada)
            {
                <div class="alert alert-warning d-flex align-items-start gap-2">
                    <i class="bi bi-shield-exclamation fs-4" aria-hidden="true"></i>
                    <div>
                        <strong>Excepción documental aplicada</strong>
                        <p class="mb-1">
                            Usuario: <strong>@Model.UsuarioExcepcionDocumental</strong>
                            @if (Model.FechaExcepcionDocumental.HasValue)
                            {
                                <span class="text-muted">- <time datetime="@Model.FechaExcepcionDocumental.Value.ToString("s")">@Model.FechaExcepcionDocumental.Value.ToString("dd/MM/yyyy HH:mm")</time></span>
                            }
                        </p>
                        <p class="mb-0"><strong>Motivo:</strong> @Model.MotivoExcepcionDocumental</p>
                    </div>
                </div>
            }

            @if (Model.TieneRequisitosPendientes)
            {
                <div class="alert alert-warning d-flex align-items-start gap-2">
                    <i class="bi bi-exclamation-triangle fs-4" aria-hidden="true"></i>
                    <div>
                        <strong>Venta con requisitos pendientes</strong>
                        <p class="mb-2">Esta venta no puede confirmarse hasta completar los siguientes requisitos:</p>
                        @if (Model.ValidacionCredito?.RequisitosPendientes?.Any() == true)
                        {
                            <ul class="mb-0">
                                @foreach (var req in Model.ValidacionCredito.RequisitosPendientes)
                                {
                                    <li>
                                        @req.Descripcion
                                        @if (!string.IsNullOrEmpty(req.AccionRequerida))
                                        {
                                            <span class="text-muted">- @req.AccionRequerida</span>
                                        }
                                    </li>
                                }
                            </ul>
                        }

                        @if (puedeAplicarExcepcionDocumental)
                        {
                            <div class="mt-3 pt-2 border-top border-warning-subtle">
                                <form asp-action="Confirmar" asp-route-id="@Model.Id" asp-route-aplicarExcepcionDocumental="true" method="post"
                                      data-confirm="¿Aplicar excepción documental y confirmar la venta? Solo use esta opción si aprobó la excepción.">
                                    @Html.AntiForgeryToken()
                                    <div class="mb-2" style="max-width: 560px;">
                                        <label for="motivoExcepcionDocumentalAnalisis" class="form-label text-warning fw-semibold mb-1">
                                            Motivo de excepción documental (obligatorio)
                                        </label>
                                        <textarea id="motivoExcepcionDocumentalAnalisis"
                                                  name="motivoExcepcionDocumental"
                                                  class="form-control"
                                                  rows="2"
                                                  maxlength="500"
                                                  required
                                                  placeholder="Describa el motivo y la validación realizada"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-shield-exclamation me-2" aria-hidden="true"></i> Confirmar por Excepción Documental
                                    </button>
                                </form>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (Model.EsPendienteFinanciacion && Model.TipoPago != TheBuryProject.Models.Enums.TipoPago.CreditoPersonal)
            {
                @* Solo mostrar si NO es CreditoPersonal (el stepper lo maneja) *@
                <div class="alert alert-info d-flex align-items-start gap-2">
                    <i class="bi bi-credit-card fs-4" aria-hidden="true"></i>
                    <div>
                        <strong>Pendiente de configuración de financiamiento</strong>
                        <p class="mb-2">Esta venta requiere que configure el plan de cuotas antes de confirmar.</p>
                        @if (Model.CreditoId.HasValue)
                        {
                            <a asp-controller="Credito" asp-action="ConfigurarVenta" 
                               asp-route-id="@Model.CreditoId" asp-route-ventaId="@Model.Id"
                               asp-route-returnUrl="@Url.Action("Details", "Venta", new { id = Model.Id })"
                               class="btn btn-info btn-sm">
                                <i class="bi bi-gear" aria-hidden="true"></i> Configurar Plan de Financiamiento
                            </a>
                        }
                    </div>
                </div>
            }

            @if (Model.DebeAlertarAutorizacionPendiente && Model.TipoPago != TheBuryProject.Models.Enums.TipoPago.CreditoPersonal)
            {
                <div class="alert alert-warning d-flex align-items-start gap-2">
                    <i class="bi bi-shield-exclamation fs-4" aria-hidden="true"></i>
                    <div>
                        <strong>Pendiente de autorización</strong>
                        @if (Model.ValidacionCredito?.RazonesAutorizacion?.Any() == true)
                        {
                            <ul class="mb-0 mt-2">
                                @foreach (var razon in Model.ValidacionCredito.RazonesAutorizacion)
                                {
                                    <li>
                                        @razon.Descripcion
                                        @if (!string.IsNullOrEmpty(razon.DetalleAdicional))
                                        {
                                            <span class="text-muted">- @razon.DetalleAdicional</span>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="mb-0 mt-1">La venta requiere autorización de un supervisor antes de confirmar.</p>
                        }
                    </div>
                </div>
            }

            @if (Model.FueRechazada)
            {
                <div class="alert alert-danger d-flex align-items-start gap-2">
                    <i class="bi bi-x-circle" aria-hidden="true"></i>
                    <div>
                        Venta rechazada por <strong>@Model.UsuarioAutoriza</strong> el <time datetime="@Model.FechaAutorizacion?.ToString("s")">@Model.FechaAutorizacion?.ToString("dd/MM/yyyy HH:mm")</time>.
                        @if (!string.IsNullOrEmpty(Model.MotivoRechazo))
                        {
                            <br />
                            <strong>Motivo:</strong> @Model.MotivoRechazo
                        }
                    </div>
                </div>
            }
        </div>

        @* ========== PANEL DE PROGRESO PARA CRÉDITO PERSONAL ========== *@
        @if (Model.TipoPago == TheBuryProject.Models.Enums.TipoPago.CreditoPersonal)
        {
            var paso1Completo = true; // Venta siempre creada si llegamos aquí
            var paso2Completo = Model.FinanciamientoConfigurado || Model.CreditoConfigurado;
            var paso3Completo = Model.Estado == TheBuryProject.Models.Enums.EstadoVenta.Confirmada || Model.CreditoGenerado;
            
            <div class="col-12">
                <div class="card bg-dark border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-light">
                        <h5 class="mb-0"><i class="bi bi-diagram-3 me-2" aria-hidden="true"></i> Progreso de la Venta con Crédito</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center position-relative" style="max-width: 600px; margin: 0 auto;">
                            @* Línea de conexión *@
                            <div class="position-absolute top-50 start-0 end-0" style="height: 3px; background: linear-gradient(to right, 
                                @(paso1Completo ? "#198754" : "#6c757d") 0%, 
                                @(paso1Completo ? "#198754" : "#6c757d") 33%, 
                                @(paso2Completo ? "#198754" : "#6c757d") 33%, 
                                @(paso2Completo ? "#198754" : "#6c757d") 66%, 
                                @(paso3Completo ? "#198754" : "#6c757d") 66%, 
                                @(paso3Completo ? "#198754" : "#6c757d") 100%); z-index: 0;"></div>
                            
                            @* Paso 1: Creada *@
                            <div class="text-center position-relative" style="z-index: 1;">
                                <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 @(paso1Completo ? "bg-success" : "bg-secondary")" style="width: 48px; height: 48px;">
                                    <i class="bi @(paso1Completo ? "bi-check-lg" : "bi-1-circle") text-white fs-5" aria-hidden="true"></i>
                                </div>
                                <small class="d-block fw-semibold @(paso1Completo ? "text-success" : "text-muted")">Creada</small>
                                <small class="text-muted">Venta registrada</small>
                            </div>
                            
                            @* Paso 2: Financiación *@
                            <div class="text-center position-relative" style="z-index: 1;">
                                <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 @(paso2Completo ? "bg-success" : paso1Completo && !paso3Completo ? "bg-info" : "bg-secondary")" style="width: 48px; height: 48px;">
                                    @if (paso2Completo)
                                    {
                                        <i class="bi bi-check-lg text-white fs-5" aria-hidden="true"></i>
                                    }
                                    else if (paso1Completo && !paso3Completo)
                                    {
                                        <i class="bi bi-gear text-white fs-5" aria-hidden="true"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-2-circle text-white fs-5" aria-hidden="true"></i>
                                    }
                                </div>
                                <small class="d-block fw-semibold @(paso2Completo ? "text-success" : paso1Completo && !paso3Completo ? "text-info" : "text-muted")">Financiación</small>
                                <small class="text-muted">Plan de cuotas</small>
                            </div>
                            
                            @* Paso 3: Confirmada *@
                            <div class="text-center position-relative" style="z-index: 1;">
                                <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 @(paso3Completo ? "bg-success" : "bg-secondary")" style="width: 48px; height: 48px;">
                                    <i class="bi @(paso3Completo ? "bi-check-lg" : "bi-3-circle") text-white fs-5" aria-hidden="true"></i>
                                </div>
                                <small class="d-block fw-semibold @(paso3Completo ? "text-success" : "text-muted")">Confirmada</small>
                                <small class="text-muted">Crédito generado</small>
                            </div>
                        </div>
                        
                        @* Acción principal según el paso actual *@
                        <div class="text-center mt-4 pt-3 border-top border-secondary">
                            @if (paso3Completo)
                            {
                                <div class="alert alert-success d-inline-flex align-items-center gap-2 mb-0">
                                    <i class="bi bi-check-circle-fill fs-4" aria-hidden="true"></i>
                                    <span><strong>¡Venta completada!</strong> El crédito ha sido generado con sus cuotas.</span>
                                </div>
                            }
                            else if (paso2Completo)
                            {
                                <p class="text-muted mb-3">La financiación está configurada. Confirme la venta para generar el crédito.</p>
                                <form asp-action="Confirmar" asp-route-id="@Model.Id" method="post" class="d-inline"
                                      data-confirm="¿Confirmar venta y generar cuotas del crédito?">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i> Confirmar Venta y Generar Crédito
                                    </button>
                                </form>
                            }
                            else if (Model.DebeAlertarAutorizacionPendiente)
                            {
                                <div class="alert alert-warning d-inline-flex align-items-center gap-2 mb-0">
                                    <i class="bi bi-shield-exclamation fs-4" aria-hidden="true"></i>
                                    <span>Esperando autorización de un supervisor antes de continuar.</span>
                                </div>
                            }
                            else if (Model.CreditoId.HasValue)
                            {
                                <p class="text-muted mb-3">Configure el plan de financiamiento: cuotas, tasa e intereses.</p>
                                <a asp-controller="Credito" asp-action="ConfigurarVenta" 
                                   asp-route-id="@Model.CreditoId" asp-route-ventaId="@Model.Id"
                                   asp-route-returnUrl="@Url.Action("Details", "Venta", new { id = Model.Id })"
                                   class="btn btn-info btn-lg">
                                    <i class="bi bi-gear me-2" aria-hidden="true"></i> Configurar Financiación
                                </a>
                            }
                            else
                            {
                                <div class="alert alert-danger d-inline-flex align-items-center gap-2 mb-0">
                                    <i class="bi bi-exclamation-triangle fs-4" aria-hidden="true"></i>
                                    <span>Error: No hay crédito asociado a esta venta.</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <div class="col-12">
            <div class="card bg-dark border-0 shadow-sm mb-4">
                <div class="card-header bg-secondary text-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2" aria-hidden="true"></i> Información General</h5>
                    <span class="@Model.EstadoBadgeClass">@Model.EstadoDisplay</span>
                </div>

                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <table class="table table-dark table-hover align-middle mb-0">
                                <tbody>
                                    <tr><th scope="row" class="text-muted">Número</th><td class="text-light fw-semibold">@Model.Numero</td></tr>
                                    <tr><th scope="row" class="text-muted">Cliente</th><td>@Model.ClienteNombre</td></tr>
                                    <tr><th scope="row" class="text-muted">Documento</th><td>@Model.ClienteDocumento</td></tr>
                                    <tr><th scope="row" class="text-muted">Fecha Venta</th><td><time datetime="@Model.FechaVenta.ToString("yyyy-MM-dd")">@Model.FechaVenta.ToString("dd/MM/yyyy")</time></td></tr>
                                    <tr><th scope="row" class="text-muted">Tipo Pago</th><td><span class="badge bg-secondary">@Model.TipoPago</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-dark table-hover align-middle mb-0">
                                <tbody>
                                    @if (!string.IsNullOrEmpty(Model.VendedorNombre))
                                    { <tr><th scope="row" class="text-muted">Vendedor</th><td>@Model.VendedorNombre</td></tr> }
                                    @if (Model.FechaConfirmacion.HasValue)
                                    { <tr><th scope="row" class="text-muted">Confirmada</th><td><time datetime="@Model.FechaConfirmacion.Value.ToString("s")">@Model.FechaConfirmacion.Value.ToString("dd/MM/yyyy HH:mm")</time></td></tr> }
                                    @if (Model.FechaFacturacion.HasValue)
                                    { <tr><th scope="row" class="text-muted">Facturada</th><td><time datetime="@Model.FechaFacturacion.Value.ToString("s")">@Model.FechaFacturacion.Value.ToString("dd/MM/yyyy HH:mm")</time></td></tr> }
                                    @if (Model.FechaCancelacion.HasValue)
                                    { <tr><th scope="row" class="text-muted">Cancelada</th><td><time datetime="@Model.FechaCancelacion.Value.ToString("s")">@Model.FechaCancelacion.Value.ToString("dd/MM/yyyy HH:mm")</time></td></tr> }
                                    <tr><th scope="row" class="text-muted">Creada</th><td><time datetime="@Model.CreatedAt.ToString("s")">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</time></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Observaciones))
                    {
                        <div class="alert alert-info mt-3 mb-0"><strong>Observaciones:</strong> @Model.Observaciones</div>
                    }

                    @if (!string.IsNullOrEmpty(Model.MotivoCancelacion))
                    {
                        <div class="alert alert-danger mt-3 mb-0"><strong>Motivo de Cancelación:</strong> @Model.MotivoCancelacion</div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card bg-dark border-0 shadow-sm mb-4">
                <div class="card-header bg-secondary text-light">
                    <h5 class="mb-0"><i class="bi bi-box-seam me-2" aria-hidden="true"></i> Productos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover align-middle mb-0">
                            <thead class="table-secondary text-dark">
                                <tr>
                                    <th scope="col">Código</th>
                                    <th scope="col">Producto</th>
                                    <th scope="col" class="text-center">Cantidad</th>
                                    <th scope="col" class="text-end">Precio Unit. (c/IVA)</th>
                                    <th scope="col" class="text-end">Descuento</th>
                                    <th scope="col" class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detalle in Model.Detalles)
                                {
                                    <tr>
                                        <td>@detalle.ProductoCodigo</td>
                                        <td>@detalle.ProductoNombre</td>
                                        <td class="text-center">@detalle.Cantidad</td>
                                        <td class="text-end">@detalle.PrecioUnitario.ToString("C2")</td>
                                        <td class="text-end">@detalle.Descuento.ToString("C2")</td>
                                        <td class="text-end fw-semibold">@detalle.Subtotal.ToString("C2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-secondary text-dark">
                                <tr><td colspan="5" class="text-end fw-semibold">Subtotal (IVA incluido):</td><td class="text-end">@Model.Subtotal.ToString("C2")</td></tr>
                                @if (Model.Descuento > 0)
                                { <tr><td colspan="5" class="text-end fw-semibold">Descuento:</td><td class="text-end text-danger">-@Model.Descuento.ToString("C2")</td></tr> }
                                <tr><td colspan="5" class="text-end fw-semibold"><small class="text-muted">IVA (21% desglosado):</small></td><td class="text-end"><small class="text-muted">@Model.IVA.ToString("C2")</small></td></tr>
                                <tr class="table-success">
                                    <td colspan="5" class="text-end fs-5">TOTAL:</td>
                                    <td class="text-end fs-5 fw-bold">@Model.Total.ToString("C2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-gear" aria-hidden="true"></i> Acciones</h5>
                </div>
                <div class="card-body">
                    @* Para Crédito Personal: mostrar acciones simplificadas *@
                    @if (Model.TipoPago == TheBuryProject.Models.Enums.TipoPago.CreditoPersonal)
                    {
                        <div class="d-flex flex-wrap gap-2">
                            @* Autorización (si aplica) *@
                            @if (Model.PuedeAutorizar)
                            {
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAutorizarVenta">
                                    <i class="bi bi-check-lg" aria-hidden="true"></i> Autorizar
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazarVenta">
                                    <i class="bi bi-x-lg" aria-hidden="true"></i> Rechazar
                                </button>
                            }

                            @* Indicador si crédito ya generado *@
                            @if (Model.CreditoGenerado)
                            {
                                <span class="badge bg-success py-2 px-3">
                                    <i class="bi bi-check-circle-fill" aria-hidden="true"></i> Crédito Generado
                                </span>
                            }

                            @if (Model.PuedeFacturar)
                            {
                                <a asp-action="Facturar" asp-route-id="@Model.Id" class="btn btn-success"><i class="bi bi-receipt" aria-hidden="true"></i> Facturar</a>
                            }

                            @if (Model.PuedeCrearDevolucion)
                            {
                                <a asp-controller="Devolucion" asp-action="Create" asp-route-ventaId="@Model.Id" class="btn btn-outline-warning">
                                    <i class="bi bi-arrow-return-left" aria-hidden="true"></i> Crear Devolución
                                </a>
                            }

                            @if (Model.PuedeCancelar && !Model.CreditoGenerado)
                            {
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalCancelarVenta">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i> Cancelar
                                </button>
                            }

                            @* Editar desprioritizado: solo como link secundario *@
                            @if (Model.PuedeEditar && !Model.CreditoGenerado)
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary btn-sm ms-auto">
                                    <i class="bi bi-pencil" aria-hidden="true"></i> Corregir datos
                                </a>
                            }

                            @if (Model.PuedeEditar && !Model.CreditoGenerado)
                            {
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger btn-sm" aria-label="Eliminar venta @Model.Numero"><i class="bi bi-trash" aria-hidden="true"></i><span class="visually-hidden">Eliminar venta</span></a>
                            }
                        </div>
                    }
                    else
                    {
                        @* Para otros tipos de pago: acciones normales *@
                        <div class="d-flex flex-wrap gap-2">
                            @if (Model.PuedeEditar)
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning"><i class="bi bi-pencil" aria-hidden="true"></i> Editar</a>
                            }

                            @if (Model.PuedeAutorizar)
                            {
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAutorizarVenta">
                                    <i class="bi bi-check-lg" aria-hidden="true"></i> Autorizar
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazarVenta">
                                    <i class="bi bi-x-lg" aria-hidden="true"></i> Rechazar
                                </button>
                            }

                            @if (Model.PuedeConfirmar)
                            {
                                <form asp-action="Confirmar" asp-route-id="@Model.Id" method="post" class="d-inline" 
                                      data-confirm="¿Confirmar esta venta? Se descontará el stock.">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle" aria-hidden="true"></i> Confirmar
                                    </button>
                                </form>
                            }

                            @if (Model.PuedeFacturar)
                            {
                                <a asp-action="Facturar" asp-route-id="@Model.Id" class="btn btn-success"><i class="bi bi-receipt" aria-hidden="true"></i> Facturar</a>
                            }

                            @if (Model.PuedeCrearDevolucion)
                            {
                                <a asp-controller="Devolucion" asp-action="Create" asp-route-ventaId="@Model.Id" class="btn btn-outline-warning">
                                    <i class="bi bi-arrow-return-left" aria-hidden="true"></i> Crear Devolución
                                </a>
                            }

                            @if (Model.PuedeCancelar)
                            {
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalCancelarVenta">
                                    <i class="bi bi-x-circle" aria-hidden="true"></i> Cancelar
                                </button>
                            }

                            @if (Model.PuedeEditar)
                            {
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger"><i class="bi bi-trash" aria-hidden="true"></i> Eliminar</a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

@if (Model.PuedeAutorizar)
{
    <div class="modal fade" id="modalAutorizarVenta" tabindex="-1" aria-labelledby="modalAutorizarVentaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-success">
                <form asp-action="Autorizar" asp-route-id="@Model.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-header border-success-subtle">
                        <h5 class="modal-title" id="modalAutorizarVentaLabel">
                            <i class="bi bi-check-circle me-2" aria-hidden="true"></i>Autorizar venta
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="motivoAutorizarVenta" class="form-label">Motivo/observación</label>
                        <textarea id="motivoAutorizarVenta" name="motivo" class="form-control" rows="3" maxlength="500" required
                                  placeholder="Ingrese observación de autorización"></textarea>
                    </div>
                    <div class="modal-footer border-success-subtle">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Autorizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRechazarVenta" tabindex="-1" aria-labelledby="modalRechazarVentaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-danger">
                <form asp-action="Rechazar" asp-route-id="@Model.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-header border-danger-subtle">
                        <h5 class="modal-title" id="modalRechazarVentaLabel">
                            <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Rechazar venta
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="motivoRechazarVenta" class="form-label">Motivo del rechazo</label>
                        <textarea id="motivoRechazarVenta" name="motivo" class="form-control" rows="3" maxlength="500" required
                                  placeholder="Ingrese motivo de rechazo"></textarea>
                    </div>
                    <div class="modal-footer border-danger-subtle">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Rechazar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@if (Model.PuedeCancelar && (!Model.CreditoGenerado || Model.TipoPago != TheBuryProject.Models.Enums.TipoPago.CreditoPersonal))
{
    <div class="modal fade" id="modalCancelarVenta" tabindex="-1" aria-labelledby="modalCancelarVentaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-warning">
                <form asp-action="Cancelar" asp-route-id="@Model.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="modal-header border-warning-subtle">
                        <h5 class="modal-title" id="modalCancelarVentaLabel">
                            <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>Cancelar venta
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="motivoCancelarVenta" class="form-label">Motivo de cancelación</label>
                        <textarea id="motivoCancelarVenta" name="motivo" class="form-control" rows="3" maxlength="500" required
                                  placeholder="Ingrese motivo de cancelación"></textarea>
                    </div>
                    <div class="modal-footer border-warning-subtle">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Volver</button>
                        <button type="submit" class="btn btn-warning">Cancelar venta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
