@model TheBuryProject.ViewModels.VentaViewModel

@{
    var esCotizacion = Model.Estado == TheBuryProject.Models.Enums.EstadoVenta.Cotizacion;
    ViewData["Title"] = esCotizacion ? "Nueva Cotización" : "Nueva Venta";
    ViewData["PageTitle"] = ViewData["Title"];
    ViewData["PageSubtitle"] = esCotizacion ? "Armá la propuesta y definí la forma de pago." : "Generá la venta y seleccioná el medio de cobro.";
}

@section Styles {
    <link rel="stylesheet" href="~/css/venta.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light venta-section">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h2 class="mb-1"><i class="bi bi-@(esCotizacion ? "file-earmark-text" : "plus-circle") me-2 text-primary"></i> @ViewData["Title"]</h2>
                    <p class="mb-0 text-muted">@ViewData["PageSubtitle"]</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div class="col-12">
            <div class="alert alert-info alert-inline mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-info-circle fs-5"></i>
                <div>
                    <strong class="d-block">@(esCotizacion ? "Cotización" : "Venta")</strong>
                    <small class="text-muted">
                        @(esCotizacion
                            ? "Primero arma el listado de productos. Luego elige el tipo de pago; si es crédito personal, la documentación y el cálculo se completan en el paso siguiente."
                            : "Primero arma el listado de productos y total. Luego selecciona la forma de pago; si es crédito personal, el sistema validará documentación antes de configurar el crédito.")
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12">
            <form asp-action="Create" method="post" id="formVenta"
                  data-get-tarjetas-url="@Url.Action("GetTarjetasActivas", "Venta")"
                  data-calcular-cuotas-url="@Url.Action("CalcularCuotasTarjeta", "VentaApi")"
                data-buscar-productos-url="@Url.Action("BuscarProductos", "VentaApi")"
                  data-get-precio-producto-url="@Url.Action("GetPrecioProducto", "VentaApi")"
                  data-calcular-totales-url="@Url.Action("CalcularTotalesVenta", "VentaApi")"
                  data-prevalidar-credito-url="@Url.Action("PrevalidarCredito", "Venta")"
                                data-puede-excepcion-documental="@User.TienePermiso("ventas", "authorize").ToString().ToLowerInvariant()"
                data-descuento-es-porcentaje="false">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                <input type="hidden" asp-for="Estado" />
                                <input type="hidden" asp-for="AplicarExcepcionDocumental" id="aplicarExcepcionDocumental" />
                <input type="hidden" asp-for="MotivoExcepcionDocumentalCreate" id="motivoExcepcionDocumentalHidden" />

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-secondary text-light d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                <span class="badge badge-soft">Stock visible en cada selección</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <label class="form-label small mb-1" for="productoCategoriaFiltro">Categoría</label>
                        <select id="productoCategoriaFiltro" class="form-select form-select-sm bg-body-secondary text-light border-0" asp-items="ViewBag.CategoriasFiltro">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small mb-1" for="productoMarcaFiltro">Marca</label>
                        <select id="productoMarcaFiltro" class="form-select form-select-sm bg-body-secondary text-light border-0" asp-items="ViewBag.MarcasFiltro">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1" for="productoPrecioMinFiltro">Precio mín.</label>
                        <input type="number" id="productoPrecioMinFiltro" class="form-control form-control-sm bg-body-secondary text-light border-0" step="0.01" min="0" placeholder="0" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small mb-1" for="productoPrecioMaxFiltro">Precio máx.</label>
                        <input type="number" id="productoPrecioMaxFiltro" class="form-control form-control-sm bg-body-secondary text-light border-0" step="0.01" min="0" placeholder="Sin tope" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-check form-switch ms-md-2">
                            <input class="form-check-input" type="checkbox" id="productoSoloStockFiltro" checked>
                            <label class="form-check-label" for="productoSoloStockFiltro">Solo con stock</label>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="form-label" for="productoSearchInput">Producto</label>
                        <div class="position-relative">
                            <input type="text" id="productoSearchInput" class="form-control bg-body-secondary text-light border-0" placeholder="Buscar producto por código, nombre, marca, categoría, descripción o características..." autocomplete="off" aria-controls="productoSearchResults" aria-expanded="false" aria-activedescendant="" aria-autocomplete="list" />
                            <div id="productoSearchResults" class="list-group position-absolute w-100 shadow d-none" style="z-index: 1080;" role="listbox"></div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="cantidadInput">Cantidad</label>
                        <input type="number" id="cantidadInput" class="form-control bg-body-secondary text-light border-0" value="1" min="1" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="precioInput">Precio unit.</label>
                        <input type="number" id="precioInput" class="form-control bg-body-secondary text-light border-0" step="0.01" readonly />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="descuentoInput">Desc. ($)</label>
                        <input type="number" id="descuentoInput" class="form-control bg-body-secondary text-light border-0" value="0" step="0.01" min="0" />
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="tablaProductos">
                        <thead class="table-secondary text-dark">
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio unit.</th>
                                <th class="text-end">Descuento</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productosBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-primary text-light">
                <h5 class="mb-0">Datos generales</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label asp-for="ClienteId" class="form-label"></label>
                        <select asp-for="ClienteId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Clientes" id="clienteSelect" required>
                            <option value="">Seleccione un cliente...</option>
                        </select>
                        <span asp-validation-for="ClienteId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="FechaVenta" class="form-label"></label>
                        <input asp-for="FechaVenta" class="form-control bg-body-secondary text-light border-0" type="date" />
                        <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="TipoPago" class="form-label"></label>
                        <select asp-for="TipoPago" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.TiposPago" id="tipoPagoSelect" required>
                            <option value="">Seleccione tipo de pago...</option>
                        </select>
                        <span asp-validation-for="TipoPago" class="text-danger small"></span>
                    </div>

                    <div class="col-md-2">
                        <label asp-for="Descuento" class="form-label"></label>
                        <input asp-for="Descuento" class="form-control bg-body-secondary text-light border-0" type="number" step="0.01" id="descuentoGeneral" />
                        <span asp-validation-for="Descuento" class="text-danger small"></span>
                    </div>
                </div>

                <!-- Aviso CréditoPersonal: se muestra dinámicamente cuando se selecciona -->
                <div class="alert alert-info mt-3 d-none" id="avisoCreditoPersonal">
                    <div class="d-flex align-items-start gap-2">
                        <i class="bi bi-credit-card-2-front fs-4"></i>
                        <div>
                            <strong>Crédito Personal seleccionado</strong>
                            <p class="mb-0 mt-1">
                                <i class="bi bi-arrow-right me-1"></i>
                                La configuración del financiamiento (cuotas, tasa, anticipo) se realizará en el <strong>siguiente paso</strong> después de crear la venta.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="alert alert-secondary mt-3 d-none" id="resumenCreditoDisponibleInline">
                    <div class="d-flex flex-wrap gap-4 align-items-center">
                        <div><strong>Disponible:</strong> <span id="inlineCreditoDisponible">$0.00</span></div>
                        <div><strong>Esta venta en crédito:</strong> <span id="inlineCreditoVenta">$0.00</span></div>
                    </div>
                    <div class="mt-2 text-danger d-none" id="inlineCreditoExcedeMensaje">
                        Excede el crédito disponible por puntaje. Disponible: <span id="inlineCreditoExcedeDisponible">$0.00</span>. Ajuste el monto, cambie método de pago o actualice puntaje/límites.
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="tarjetaRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-credit-card me-1"></i> Pago con tarjeta</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label" for="tarjetaSelect">Tarjeta</label>
                        <select id="tarjetaSelect" class="form-select bg-body-secondary text-light border-0">
                            <option value="">Seleccione tarjeta...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-none" id="cuotasDiv">
                        <label class="form-label" for="cuotasSelect">Cuotas</label>
                        <select id="cuotasSelect" class="form-select bg-body-secondary text-light border-0"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="nroAutorizacion">Nro. autorización</label>
                        <input type="text" id="nroAutorizacion" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
                <div id="infoCuotas" class="mt-3 d-none">
                    <div class="alert alert-info mb-0">
                        <strong>Monto por cuota:</strong> $<span id="lblMontoCuota">0.00</span> |
                        <strong>Total con interés:</strong> $<span id="lblMontoTotal">0.00</span> |
                        <strong>Interés:</strong> $<span id="lblInteres">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="chequeRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-bank me-1"></i> Pago con cheque</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label" for="chequenumero">Número de cheque</label>
                        <input type="text" id="chequenumero" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeBanco">Banco</label>
                        <input type="text" id="chequeBanco" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeTitular">Titular</label>
                        <input type="text" id="chequeTitular" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeCUIT">CUIT</label>
                        <input type="text" id="chequeCUIT" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaEmision">Fecha emisión</label>
                        <input type="date" id="chequeFechaEmision" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaVencimiento">Fecha vencimiento</label>
                        <input type="date" id="chequeFechaVencimiento" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Prevalidación de Crédito Personal -->
        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="prevalidacionRow">
            <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-shield-check me-1"></i> Verificación de Aptitud Crediticia</h5>
                <button type="button" class="btn btn-sm btn-outline-dark" id="btnVerificarAptitud" disabled>
                    <i class="bi bi-search"></i> Verificar Aptitud
                </button>
            </div>
            <div class="card-body">
                <div id="prevalidacionPendiente" class="text-muted">
                    <i class="bi bi-info-circle me-2"></i>
                    Agregue productos al carrito y haga clic en "Verificar Aptitud" para evaluar la capacidad crediticia del cliente.
                </div>
                <div id="prevalidacionCargando" class="d-none text-center py-3">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Verificando...</span>
                    </div>
                    <p class="text-muted mt-2 mb-0">Verificando aptitud crediticia...</p>
                </div>
                <div id="prevalidacionResultado" class="d-none">
                    <div class="d-flex align-items-center mb-3">
                        <span id="prevalidacionBadge" class="badge fs-6 me-3"></span>
                        <span id="prevalidacionTexto" class="fw-bold"></span>
                    </div>
                    <div id="prevalidacionDetalles">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card bg-body-secondary border-0">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Límite de Crédito</small>
                                        <div class="fw-bold" id="prevalidacionLimite">$0.00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-body-secondary border-0">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Cupo Disponible</small>
                                        <div class="fw-bold" id="prevalidacionCupo">$0.00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-body-secondary border-0">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Monto Solicitado</small>
                                        <div class="fw-bold" id="prevalidacionMonto">$0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="prevalidacionMora" class="alert alert-warning mt-3 d-none">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="prevalidacionMoraTexto"></span>
                        </div>
                        <div id="prevalidacionMotivos" class="mt-3">
                            <!-- Los motivos se cargarán dinámicamente -->
                        </div>

                        @if (User.TienePermiso("ventas", "authorize"))
                        {
                            <div class="mt-3 pt-3 border-top border-secondary" id="excepcionDocumentalPanel">
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <button type="button" class="btn btn-warning btn-sm" id="btnAplicarExcepcionDocumental">
                                        <i class="bi bi-shield-exclamation me-1"></i> Aplicar Excepción Documental
                                    </button>
                                    <span class="badge bg-secondary" id="estadoExcepcionDocumental">No aplicada</span>
                                </div>
                                <div class="mb-2" style="max-width: 560px;">
                                    <label for="motivoExcepcionDocumentalInput" class="form-label text-warning fw-semibold mb-1">
                                        Motivo de excepción documental (obligatorio)
                                    </label>
                                    <textarea id="motivoExcepcionDocumentalInput"
                                              class="form-control"
                                              rows="2"
                                              maxlength="500"
                                              placeholder="Describa el motivo y la validación realizada"></textarea>
                                    <small class="text-muted">Solo aplica para bloqueos por documentación faltante.</small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3">
                    @if ((bool?)ViewBag.PuedeDelegarVendedor == true)
                    {
                        <div class="col-md-6">
                            <label asp-for="VendedorUserId" class="form-label"></label>
                            <select asp-for="VendedorUserId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Vendedores">
                                <option value="">Seleccione un vendedor...</option>
                            </select>
                            <span asp-validation-for="VendedorUserId" class="text-danger small"></span>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-6">
                            <label class="form-label">Vendedor</label>
                            <input class="form-control bg-body-secondary text-light border-0" value="@User.Identity?.Name" readonly />
                        </div>
                    }
                    <div class="col-md-6">
                        <label asp-for="Observaciones" class="form-label"></label>
                        <textarea asp-for="Observaciones" class="form-control bg-body-secondary text-light border-0" rows="2"></textarea>
                        <span asp-validation-for="Observaciones" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-success text-light">
                <h5 class="mb-0">Totales</h5>
            </div>
            <div class="card-body">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Subtotal</div>
                        <div class="value" id="lblSubtotal">$0.00</div>
                        <input type="hidden" asp-for="Subtotal" id="hiddenSubtotal" />
                    </div>
                    <div class="summary-item">
                        <div class="label">Descuento</div>
                        <div class="value" id="lblDescuento">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="label"><small class="text-muted">IVA 21% (desglosado)</small></div>
                        <div class="value text-muted" id="lblIVA">$0.00</div>
                        <input type="hidden" id="ivaRate" value="@ViewBag.IvaRate" />
                        <input type="hidden" asp-for="IVA" id="hiddenIVA" />
                    </div>
                    <div class="summary-item totales-destacado">
                        <div class="label">Total</div>
                        <div class="value" id="lblTotal">$0.00</div>
                        <input type="hidden" asp-for="Total" id="hiddenTotal" />
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> @(esCotizacion ? "Guardar cotización" : "Guardar venta")
            </button>
        </div>
    </form>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/venta-common.js" asp-append-version="true"></script>
    <script src="~/js/venta-create.js" asp-append-version="true"></script>
}
