@model TheBuryProject.ViewModels.VentaViewModel

@{
    var esCotizacion = Model.Estado == TheBuryProject.Models.Enums.EstadoVenta.Cotizacion;
    ViewData["Title"] = esCotizacion ? "Nueva Cotización" : "Nueva Venta";
    ViewData["PageTitle"] = ViewData["Title"];
    ViewData["PageSubtitle"] = esCotizacion ? "Armá la propuesta y definí la forma de pago." : "Generá la venta y seleccioná el medio de cobro.";
}

@section Styles {
    <link rel="stylesheet" href="~/css/venta.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light venta-section">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h2 class="mb-1"><i class="bi bi-@(esCotizacion ? "file-earmark-text" : "plus-circle") me-2 text-primary"></i> @ViewData["Title"]</h2>
                    <p class="mb-0 text-muted">@ViewData["PageSubtitle"]</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div class="col-12">
            <div class="alert alert-info alert-inline mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-info-circle fs-5"></i>
                <div>
                    <strong class="d-block">@(esCotizacion ? "Cotización" : "Venta")</strong>
                    <small class="text-muted">
                        @(esCotizacion
                            ? "Primero arma el listado de productos. Luego elige el tipo de pago; si es crédito personal, la documentación y el cálculo se completan en el paso siguiente."
                            : "Primero arma el listado de productos y total. Luego selecciona la forma de pago; si es crédito personal, el sistema validará documentación antes de configurar el crédito.")
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12">
            <form asp-action="Create" method="post" id="formVenta">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                <input type="hidden" asp-for="Estado" />

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-secondary text-light d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                <span class="badge badge-soft">Stock visible en cada selección</span>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="form-label" for="productoSelect">Producto</label>
                        <select id="productoSelect" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Productos">
                            <option value="">Seleccione un producto...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="cantidadInput">Cantidad</label>
                        <input type="number" id="cantidadInput" class="form-control bg-body-secondary text-light border-0" value="1" min="1" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="precioInput">Precio unit.</label>
                        <input type="number" id="precioInput" class="form-control bg-body-secondary text-light border-0" step="0.01" readonly />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="descuentoInput">Desc. (%)</label>
                        <input type="number" id="descuentoInput" class="form-control bg-body-secondary text-light border-0" value="0" step="0.01" min="0" max="100" />
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="tablaProductos">
                        <thead class="table-secondary text-dark">
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio unit.</th>
                                <th class="text-end">Descuento</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productosBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-primary text-light">
                <h5 class="mb-0">Datos generales</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label asp-for="ClienteId" class="form-label"></label>
                        <select asp-for="ClienteId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Clientes" id="clienteSelect" required>
                            <option value="">Seleccione un cliente...</option>
                        </select>
                        <span asp-validation-for="ClienteId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="FechaVenta" class="form-label"></label>
                        <input asp-for="FechaVenta" class="form-control bg-body-secondary text-light border-0" type="date" />
                        <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="TipoPago" class="form-label"></label>
                        <select asp-for="TipoPago" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.TiposPago" id="tipoPagoSelect" required>
                            <option value="">Seleccione tipo de pago...</option>
                        </select>
                        <span asp-validation-for="TipoPago" class="text-danger small"></span>
                        <small class="text-muted">El cálculo de crédito se hace en el paso siguiente.</small>
                    </div>

                    <div class="col-md-2">
                        <label asp-for="Descuento" class="form-label"></label>
                        <input asp-for="Descuento" class="form-control bg-body-secondary text-light border-0" type="number" step="0.01" id="descuentoGeneral" />
                        <span asp-validation-for="Descuento" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="tarjetaRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-credit-card me-1"></i> Pago con tarjeta</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label" for="tarjetaSelect">Tarjeta</label>
                        <select id="tarjetaSelect" class="form-select bg-body-secondary text-light border-0">
                            <option value="">Seleccione tarjeta...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-none" id="cuotasDiv">
                        <label class="form-label" for="cuotasSelect">Cuotas</label>
                        <select id="cuotasSelect" class="form-select bg-body-secondary text-light border-0"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="nroAutorizacion">Nro. autorización</label>
                        <input type="text" id="nroAutorizacion" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
                <div id="infoCuotas" class="mt-3 d-none">
                    <div class="alert alert-info mb-0">
                        <strong>Monto por cuota:</strong> $<span id="lblMontoCuota">0.00</span> |
                        <strong>Total con interés:</strong> $<span id="lblMontoTotal">0.00</span> |
                        <strong>Interés:</strong> $<span id="lblInteres">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="chequeRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-bank me-1"></i> Pago con cheque</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label" for="chequenumero">Número de cheque</label>
                        <input type="text" id="chequenumero" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeBanco">Banco</label>
                        <input type="text" id="chequeBanco" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeTitular">Titular</label>
                        <input type="text" id="chequeTitular" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeCUIT">CUIT</label>
                        <input type="text" id="chequeCUIT" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaEmision">Fecha emisión</label>
                        <input type="date" id="chequeFechaEmision" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaVencimiento">Fecha vencimiento</label>
                        <input type="date" id="chequeFechaVencimiento" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="VendedorNombre" class="form-label"></label>
                        <input asp-for="VendedorNombre" class="form-control bg-body-secondary text-light border-0" />
                        <span asp-validation-for="VendedorNombre" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Observaciones" class="form-label"></label>
                        <textarea asp-for="Observaciones" class="form-control bg-body-secondary text-light border-0" rows="2"></textarea>
                        <span asp-validation-for="Observaciones" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-success text-light">
                <h5 class="mb-0">Totales</h5>
            </div>
            <div class="card-body">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Subtotal</div>
                        <div class="value" id="lblSubtotal">$0.00</div>
                        <input type="hidden" asp-for="Subtotal" id="hiddenSubtotal" />
                    </div>
                    <div class="summary-item">
                        <div class="label">Descuento</div>
                        <div class="value" id="lblDescuento">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">IVA (21%)</div>
                        <div class="value" id="lblIVA">$0.00</div>
                        <input type="hidden" asp-for="IVA" id="hiddenIVA" />
                    </div>
                    <div class="summary-item totales-destacado">
                        <div class="label">Total</div>
                        <div class="value" id="lblTotal">$0.00</div>
                        <input type="hidden" asp-for="Total" id="hiddenTotal" />
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> @(esCotizacion ? "Guardar cotización" : "Guardar venta")
            </button>
        </div>
    </form>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let productosSeleccionados = [];
        let stockDisponible = {};
        let tarjetasConfig = [];

        $(document).ready(function () {
            cargarTarjetas();

            $('#tipoPagoSelect').on('change', function () {
                const tipoPago = $(this).val();
                $('#tarjetaRow, #chequeRow').addClass('d-none');

                if (tipoPago === 'TarjetaDebito' || tipoPago === 'TarjetaCredito') {
                    $('#tarjetaRow').removeClass('d-none');
                } else if (tipoPago === 'Cheque') {
                    $('#chequeRow').removeClass('d-none');
                    $('#chequeFechaEmision').val(new Date().toISOString().split('T')[0]);
                }
            });

            $('#productoSelect').on('change', function () {
                const productoId = $(this).val();
                if (productoId) {
                    cargarPrecioProducto(productoId);
                } else {
                    $('#precioInput').val('');
                    $('#cantidadInput').val(1);
                    $('#descuentoInput').val(0);
                }
            });

            $('#btnAgregarProducto').on('click', function () {
                agregarProducto();
            });

            $('#tarjetaSelect').on('change', function () {
                configurarTarjeta($(this).val());
            });

            $('#cuotasSelect').on('change', function () {
                calcularCuotasTarjeta();
            });

            $('#descuentoGeneral').on('change', function () {
                calcularTotales();
            });

            $('#formVenta').on('submit', function (e) {
                if (productosSeleccionados.length === 0) {
                    e.preventDefault();
                    alert('Debe agregar al menos un producto a la venta');
                }
            });
        });

        function cargarTarjetas() {
            $.get('@Url.Action("GetTarjetasActivas", "Venta")')
                .done(function (tarjetas) {
                    tarjetasConfig = tarjetas;
                    let options = '<option value="">Seleccione tarjeta...</option>';
                    tarjetas.forEach(function (tarjeta) {
                        options += `<option value="${tarjeta.id}">${tarjeta.nombre} (${tarjeta.tipo === 0 ? 'Débito' : 'Crédito'})</option>`;
                    });
                    $('#tarjetaSelect').html(options);
                });
        }

        function configurarTarjeta(tarjetaId) {
            const tarjeta = tarjetasConfig.find(t => t.id == tarjetaId);
            if (!tarjeta) return;

            if (tarjeta.permiteCuotas && tarjeta.cantidadMaximaCuotas > 1) {
                let options = '';
                for (let i = 1; i <= tarjeta.cantidadMaximaCuotas; i++) {
                    options += `<option value="${i}">${i} cuota${i > 1 ? 's' : ''}</option>`;
                }
                $('#cuotasSelect').html(options);
                $('#cuotasDiv').show();
            } else {
                $('#cuotasDiv').hide();
                $('#infoCuotas').hide();
            }
        }

        function calcularCuotasTarjeta() {
            const tarjetaId = $('#tarjetaSelect').val();
            const cuotas = $('#cuotasSelect').val();
            const total = parseFloat($('#hiddenTotal').val()) || 0;

            if (!tarjetaId || !cuotas || cuotas == 1) {
                $('#infoCuotas').hide();
                return;
            }

            $.get('@Url.Action("CalcularCuotasTarjeta", "Venta")', {
                tarjetaId: tarjetaId,
                monto: total,
                cuotas: cuotas
            })
                .done(function (resultado) {
                    $('#lblMontoCuota').text(resultado.montoCuota.toFixed(2));
                    $('#lblMontoTotal').text(resultado.montoTotal.toFixed(2));
                    $('#lblInteres').text(resultado.interes.toFixed(2));
                    $('#infoCuotas').removeClass('d-none').show();
                })
                .fail(function () {
                    $('#infoCuotas').hide();
                });
        }

        function cargarPrecioProducto(productoId) {
            const producto = $('#productoSelect option:selected').text();
            const stock = producto.match(/Stock: (\d+)/);
            if (stock && stock[1]) {
                stockDisponible[productoId] = parseInt(stock[1]);
            }

            $.get('@Url.Action("GetPrecioProducto", "Venta")', { id: productoId })
                .done(function (respuesta) {
                    if (respuesta && typeof respuesta.precioVenta !== 'undefined') {
                        $('#precioInput').val(parseFloat(respuesta.precioVenta).toFixed(2));
                        stockDisponible[productoId] = respuesta.stockActual ?? stockDisponible[productoId];
                    } else if (typeof respuesta === 'number') {
                        $('#precioInput').val(parseFloat(respuesta).toFixed(2));
                    }
                })
                .fail(function () {
                    alert('No se pudo obtener el precio del producto seleccionado.');
                    $('#precioInput').val('');
                });
        }

        function agregarProducto() {
            const productoId = $('#productoSelect').val();
            if (!productoId) {
                alert('Seleccione un producto');
                return;
            }

            const productoTexto = $('#productoSelect option:selected').text();
            const cantidad = parseInt($('#cantidadInput').val());
            const precio = parseFloat($('#precioInput').val());
            const descuentoPct = parseFloat($('#descuentoInput').val()) || 0;

            if (!cantidad || cantidad < 1) {
                alert('La cantidad debe ser mayor a cero');
                return;
            }

            if (!precio || precio <= 0) {
                alert('Precio inválido');
                return;
            }

            if (stockDisponible[productoId] < cantidad) {
                alert(`Stock insuficiente. Disponible: ${stockDisponible[productoId]}`);
                return;
            }

            const partes = productoTexto.split(' - ');
            const codigo = partes[0];
            const nombreCompleto = partes[1] || productoTexto;
            const nombre = nombreCompleto.split(' (Stock:')[0];

            const descuentoMonto = (precio * cantidad * descuentoPct) / 100;
            const subtotal = (precio * cantidad) - descuentoMonto;

            productosSeleccionados.push({
                productoId: productoId,
                codigo: codigo,
                nombre: nombre,
                cantidad: cantidad,
                precioUnitario: precio,
                descuento: descuentoMonto,
                subtotal: subtotal
            });

            actualizarTablaProductos();
            calcularTotales();

            $('#productoSelect').val('');
            $('#cantidadInput').val(1);
            $('#precioInput').val('');
            $('#descuentoInput').val(0);
        }

        function eliminarProducto(index) {
            productosSeleccionados.splice(index, 1);
            actualizarTablaProductos();
            calcularTotales();
        }

        function actualizarTablaProductos() {
            let html = '';
            productosSeleccionados.forEach(function (prod, index) {
                html += `
                    <tr>
                        <td>${prod.codigo}</td>
                        <td>${prod.nombre}</td>
                        <td class="text-center">${prod.cantidad}</td>
                        <td class="text-end">$${prod.precioUnitario.toFixed(2)}</td>
                        <td class="text-end">$${prod.descuento.toFixed(2)}</td>
                        <td class="text-end">$${prod.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarProducto(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                        <input type="hidden" name="Detalles[${index}].ProductoId" value="${prod.productoId}" />
                        <input type="hidden" name="Detalles[${index}].Cantidad" value="${prod.cantidad}" />
                        <input type="hidden" name="Detalles[${index}].PrecioUnitario" value="${prod.precioUnitario}" />
                        <input type="hidden" name="Detalles[${index}].Descuento" value="${prod.descuento}" />
                        <input type="hidden" name="Detalles[${index}].Subtotal" value="${prod.subtotal}" />
                    </tr>
                `;
            });
            $('#productosBody').html(html);
        }

        function calcularTotales() {
            const descuentoGeneral = parseFloat($('#descuentoGeneral').val()) || 0;
            let subtotal = productosSeleccionados.reduce((acc, prod) => acc + prod.subtotal, 0);
            const descuento = subtotal * (descuentoGeneral / 100);
            subtotal -= descuento;

            const iva = subtotal * 0.21;
            const total = subtotal + iva;

            $('#hiddenSubtotal').val(subtotal.toFixed(2));
            $('#hiddenIVA').val(iva.toFixed(2));
            $('#hiddenTotal').val(total.toFixed(2));

            $('#lblSubtotal').text(`$${subtotal.toFixed(2)}`);
            $('#lblDescuento').text(`$${descuento.toFixed(2)}`);
            $('#lblIVA').text(`$${iva.toFixed(2)}`);
            $('#lblTotal').text(`$${total.toFixed(2)}`);
        }
    </script>
}
