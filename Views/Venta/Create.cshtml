@model TheBuryProject.ViewModels.VentaViewModel

@{
    var esCotizacion = Model.Estado == TheBuryProject.Models.Enums.EstadoVenta.Cotizacion;
    ViewData["Title"] = esCotizacion ? "Nueva Cotización" : "Nueva Venta";
    ViewData["PageTitle"] = ViewData["Title"];
    ViewData["PageSubtitle"] = esCotizacion ? "Armá la propuesta y definí la forma de pago." : "Generá la venta y seleccioná el medio de cobro.";
}

@section Styles {
    <link rel="stylesheet" href="~/css/venta.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light venta-section">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h2 class="mb-1"><i class="bi bi-@(esCotizacion ? "file-earmark-text" : "plus-circle") me-2 text-primary"></i> @ViewData["Title"]</h2>
                    <p class="mb-0 text-muted">@ViewData["PageSubtitle"]</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div class="col-12">
            <div class="alert alert-info alert-inline mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-info-circle fs-5"></i>
                <div>
                    <strong class="d-block">@(esCotizacion ? "Cotización" : "Venta")</strong>
                    <small class="text-muted">
                        @(esCotizacion
                            ? "Primero arma el listado de productos. Luego elige el tipo de pago; si es crédito personal, la documentación y el cálculo se completan en el paso siguiente."
                            : "Primero arma el listado de productos y total. Luego selecciona la forma de pago; si es crédito personal, el sistema validará documentación antes de configurar el crédito.")
                    </small>
                </div>
            </div>
        </div>

        <div class="col-12">
            <form asp-action="Create" method="post" id="formVenta"
                  data-get-tarjetas-url="@Url.Action("GetTarjetasActivas", "Venta")"
                  data-calcular-cuotas-url="@Url.Action("CalcularCuotasTarjeta", "VentaApi")"
                  data-get-precio-producto-url="@Url.Action("GetPrecioProducto", "VentaApi")">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                <input type="hidden" asp-for="Estado" />

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-secondary text-light d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                <span class="badge badge-soft">Stock visible en cada selección</span>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="form-label" for="productoSelect">Producto</label>
                        <select id="productoSelect" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Productos">
                            <option value="">Seleccione un producto...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="cantidadInput">Cantidad</label>
                        <input type="number" id="cantidadInput" class="form-control bg-body-secondary text-light border-0" value="1" min="1" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="precioInput">Precio unit.</label>
                        <input type="number" id="precioInput" class="form-control bg-body-secondary text-light border-0" step="0.01" readonly />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label" for="descuentoInput">Desc. (%)</label>
                        <input type="number" id="descuentoInput" class="form-control bg-body-secondary text-light border-0" value="0" step="0.01" min="0" max="100" />
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="tablaProductos">
                        <thead class="table-secondary text-dark">
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio unit.</th>
                                <th class="text-end">Descuento</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productosBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-primary text-light">
                <h5 class="mb-0">Datos generales</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label asp-for="ClienteId" class="form-label"></label>
                        <select asp-for="ClienteId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Clientes" id="clienteSelect" required>
                            <option value="">Seleccione un cliente...</option>
                        </select>
                        <span asp-validation-for="ClienteId" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="FechaVenta" class="form-label"></label>
                        <input asp-for="FechaVenta" class="form-control bg-body-secondary text-light border-0" type="date" />
                        <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="TipoPago" class="form-label"></label>
                        <select asp-for="TipoPago" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.TiposPago" id="tipoPagoSelect" required>
                            <option value="">Seleccione tipo de pago...</option>
                        </select>
                        <span asp-validation-for="TipoPago" class="text-danger small"></span>
                        <small class="text-muted">El cálculo de crédito se hace en el paso siguiente.</small>
                    </div>

                    <div class="col-md-2">
                        <label asp-for="Descuento" class="form-label"></label>
                        <input asp-for="Descuento" class="form-control bg-body-secondary text-light border-0" type="number" step="0.01" id="descuentoGeneral" />
                        <span asp-validation-for="Descuento" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="tarjetaRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-credit-card me-1"></i> Pago con tarjeta</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label" for="tarjetaSelect">Tarjeta</label>
                        <select id="tarjetaSelect" class="form-select bg-body-secondary text-light border-0">
                            <option value="">Seleccione tarjeta...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-none" id="cuotasDiv">
                        <label class="form-label" for="cuotasSelect">Cuotas</label>
                        <select id="cuotasSelect" class="form-select bg-body-secondary text-light border-0"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="nroAutorizacion">Nro. autorización</label>
                        <input type="text" id="nroAutorizacion" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
                <div id="infoCuotas" class="mt-3 d-none">
                    <div class="alert alert-info mb-0">
                        <strong>Monto por cuota:</strong> $<span id="lblMontoCuota">0.00</span> |
                        <strong>Total con interés:</strong> $<span id="lblMontoTotal">0.00</span> |
                        <strong>Interés:</strong> $<span id="lblInteres">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3 d-none" id="chequeRow">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0"><i class="bi bi-bank me-1"></i> Pago con cheque</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label" for="chequenumero">Número de cheque</label>
                        <input type="text" id="chequenumero" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeBanco">Banco</label>
                        <input type="text" id="chequeBanco" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeTitular">Titular</label>
                        <input type="text" id="chequeTitular" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeCUIT">CUIT</label>
                        <input type="text" id="chequeCUIT" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaEmision">Fecha emisión</label>
                        <input type="date" id="chequeFechaEmision" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="chequeFechaVencimiento">Fecha vencimiento</label>
                        <input type="date" id="chequeFechaVencimiento" class="form-control bg-body-secondary text-light border-0" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="VendedorNombre" class="form-label"></label>
                        <input asp-for="VendedorNombre" class="form-control bg-body-secondary text-light border-0" />
                        <span asp-validation-for="VendedorNombre" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Observaciones" class="form-label"></label>
                        <textarea asp-for="Observaciones" class="form-control bg-body-secondary text-light border-0" rows="2"></textarea>
                        <span asp-validation-for="Observaciones" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-dark border-0 shadow-sm mb-3">
            <div class="card-header bg-success text-light">
                <h5 class="mb-0">Totales</h5>
            </div>
            <div class="card-body">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Subtotal</div>
                        <div class="value" id="lblSubtotal">$0.00</div>
                        <input type="hidden" asp-for="Subtotal" id="hiddenSubtotal" />
                    </div>
                    <div class="summary-item">
                        <div class="label">Descuento</div>
                        <div class="value" id="lblDescuento">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">IVA (@(((decimal)ViewBag.IvaRate * 100).ToString("0"))%)</div>
                        <div class="value" id="lblIVA">$0.00</div>
                        <input type="hidden" id="ivaRate" value="@ViewBag.IvaRate" />
                        <input type="hidden" asp-for="IVA" id="hiddenIVA" />
                    </div>
                    <div class="summary-item totales-destacado">
                        <div class="label">Total</div>
                        <div class="value" id="lblTotal">$0.00</div>
                        <input type="hidden" asp-for="Total" id="hiddenTotal" />
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> @(esCotizacion ? "Guardar cotización" : "Guardar venta")
            </button>
        </div>
    </form>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/venta-create.js" asp-append-version="true"></script>
}
