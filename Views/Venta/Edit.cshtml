@model TheBuryProject.ViewModels.VentaViewModel
@{
    ViewData["Title"] = "Editar Venta";
    ViewData["PageTitle"] = ViewData["Title"];
    ViewData["PageSubtitle"] = "Actualiza los datos de la venta antes de confirmar.";
}

@section Styles {
    <link rel="stylesheet" href="~/css/venta.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light venta-section">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h2 class="mb-1"><i class="bi bi-pencil me-2 text-primary" aria-hidden="true"></i> @ViewData["Title"]</h2>
                    <p class="mb-0 text-muted">@ViewData["PageSubtitle"]</p>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i> Volver
                </a>
            </div>
        </div>

        <div class="col-12">
            <div class="alert alert-info alert-inline mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-info-circle fs-5" aria-hidden="true"></i>
                <div>
                    <strong class="d-block">Edicion de venta</strong>
                    <small class="text-muted">Revisa productos, forma de pago y totales antes de guardar cambios.</small>
                </div>
            </div>
        </div>

        <div class="col-12">
            <form asp-action="Edit" method="post" id="formVenta" novalidate
                  data-get-tarjetas-url="@Url.Action("GetTarjetasActivas", "Venta")"
                  data-calcular-cuotas-url="@Url.Action("CalcularCuotasTarjeta", "VentaApi")"
                data-buscar-productos-url="@Url.Action("BuscarProductos", "VentaApi")"
                  data-get-precio-producto-url="@Url.Action("GetPrecioProducto", "VentaApi")"
                  data-calcular-totales-url="@Url.Action("CalcularTotalesVenta", "VentaApi")"
                  data-prevalidar-credito-url="@Url.Action("PrevalidarCredito", "Venta")"
                  data-descuento-es-porcentaje="false">
                @Html.AntiForgeryToken()
                @if (!ViewData.ModelState.IsValid)
                {
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert" aria-label="Errores de validación"></div>
                }
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="RowVersion" />
                <input type="hidden" asp-for="Numero" />

                <div class="card bg-dark border-0 shadow-sm mb-3" id="financiamientoRow">
                    <div class="card-header bg-secondary text-light d-flex align-items-center justify-content-between">
                        <h5 class="mb-0"><i class="bi bi-box-seam me-2" aria-hidden="true"></i> Productos</h5>
                        <span class="badge badge-soft">Stock visible en cada seleccion</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <label class="form-label small mb-1" for="productoCategoriaFiltro">Categoría</label>
                                <select id="productoCategoriaFiltro" class="form-select form-select-sm bg-body-secondary text-light border-0" asp-items="ViewBag.CategoriasFiltro">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small mb-1" for="productoMarcaFiltro">Marca</label>
                                <select id="productoMarcaFiltro" class="form-select form-select-sm bg-body-secondary text-light border-0" asp-items="ViewBag.MarcasFiltro">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1" for="productoPrecioMinFiltro">Precio mín.</label>
                                <input type="number" id="productoPrecioMinFiltro" class="form-control form-control-sm bg-body-secondary text-light border-0" step="0.01" min="0" placeholder="0" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-1" for="productoPrecioMaxFiltro">Precio máx.</label>
                                <input type="number" id="productoPrecioMaxFiltro" class="form-control form-control-sm bg-body-secondary text-light border-0" step="0.01" min="0" placeholder="Sin tope" />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <div class="form-check form-switch ms-md-2">
                                    <input class="form-check-input" type="checkbox" id="productoSoloStockFiltro" checked>
                                    <label class="form-check-label" for="productoSoloStockFiltro">Solo con stock</label>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-5">
                                <label class="form-label" for="productoSearchInput">Producto</label>
                                <div class="position-relative">
                                    <input type="text" id="productoSearchInput" class="form-control bg-body-secondary text-light border-0" placeholder="Buscar producto por código, nombre, marca, categoría, descripción o características..." autocomplete="off" aria-controls="productoSearchResults" aria-expanded="false" aria-activedescendant="" aria-autocomplete="list" />
                                    <div id="productoSearchResults" class="list-group position-absolute w-100 shadow d-none" style="z-index: 1080;" role="listbox"></div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" for="cantidadInput">Cantidad</label>
                                <input type="number" id="cantidadInput" class="form-control bg-body-secondary text-light border-0" value="1" min="1" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" for="precioInput">Precio unit.</label>
                                <input type="number" id="precioInput" class="form-control bg-body-secondary text-light border-0" step="0.01" readonly />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" for="descuentoInput">Desc. ($)</label>
                                <input type="number" id="descuentoInput" class="form-control bg-body-secondary text-light border-0" value="0" step="0.01" min="0" />
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                                    <i class="bi bi-plus" aria-hidden="true"></i>
                                    <span class="visually-hidden">Agregar producto</span>
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark table-hover align-middle" id="tablaProductos">
                                <thead class="table-secondary text-dark">
                                    <tr>
                                        <th scope="col">Codigo</th>
                                        <th scope="col">Producto</th>
                                        <th scope="col" class="text-center">Cantidad</th>
                                        <th scope="col" class="text-end">Precio unit.</th>
                                        <th scope="col" class="text-end">Descuento</th>
                                        <th scope="col" class="text-end">Subtotal</th>
                                        <th scope="col" class="text-center">Accion</th>
                                    </tr>
                                </thead>
                                <tbody id="productosBody">
                                    @foreach (var detalle in Model.Detalles)
                                    {
                                        <tr data-index="@detalle.Id">
                                            <td>@detalle.ProductoCodigo</td>
                                            <td>@detalle.ProductoNombre</td>
                                            <td class="text-center">@detalle.Cantidad</td>
                                            <td class="text-end">$@detalle.PrecioUnitario.ToString("F2")</td>
                                            <td class="text-end">$@detalle.Descuento.ToString("F2")</td>
                                            <td class="text-end">$@detalle.Subtotal.ToString("F2")</td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-danger btn-eliminar-producto" data-index="@detalle.Id" aria-label="Eliminar producto @detalle.ProductoNombre">
                                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                                    <span class="visually-hidden">Eliminar producto</span>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card bg-dark border-0 shadow-sm mb-3">
                    <div class="card-header bg-primary text-light">
                        <h5 class="mb-0">Datos generales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="ClienteId" class="form-label"></label>
                                <select asp-for="ClienteId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Clientes" id="clienteSelect" required>
                                    <option value="">Seleccione un cliente...</option>
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="FechaVenta" class="form-label"></label>
                                <input asp-for="FechaVenta" class="form-control bg-body-secondary text-light border-0" type="date" />
                                <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="TipoPago" class="form-label"></label>
                                <select asp-for="TipoPago" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.TiposPago" id="tipoPagoSelect" required>
                                    <option value="">Seleccione tipo de pago...</option>
                                </select>
                                <span asp-validation-for="TipoPago" class="text-danger small"></span>
                            </div>

                            <div class="col-md-2">
                                <label asp-for="Descuento" class="form-label"></label>
                                <input asp-for="Descuento" class="form-control bg-body-secondary text-light border-0" type="number" step="0.01" id="descuentoGeneral" />
                                <span asp-validation-for="Descuento" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financiamiento removido: Edit se alinea con Create -->

                <div class="card bg-dark border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            @if ((bool?)ViewBag.PuedeDelegarVendedor == true)
                            {
                                <div class="col-md-6">
                                    <label asp-for="VendedorUserId" class="form-label"></label>
                                    <select asp-for="VendedorUserId" class="form-select bg-body-secondary text-light border-0" asp-items="ViewBag.Vendedores">
                                        <option value="">Seleccione un vendedor...</option>
                                    </select>
                                    <span asp-validation-for="VendedorUserId" class="text-danger small"></span>
                                </div>
                            }
                            else
                            {
                                <div class="col-md-6">
                                    <label class="form-label">Vendedor</label>
                                    <input class="form-control bg-body-secondary text-light border-0" value="@(Model.VendedorNombre ?? "Sin asignar")" readonly />
                                </div>
                            }
                            <div class="col-md-6">
                                <label asp-for="Observaciones" class="form-label"></label>
                                <textarea asp-for="Observaciones" class="form-control bg-body-secondary text-light border-0" rows="2"></textarea>
                                <span asp-validation-for="Observaciones" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bg-dark border-0 shadow-sm mb-3">
                    <div class="card-header bg-success text-light">
                        <h5 class="mb-0">Totales</h5>
                    </div>
                    <div class="card-body">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="label">Subtotal</div>
                                <div class="value" id="lblSubtotal">$0.00</div>
                                <input type="hidden" asp-for="Subtotal" id="hiddenSubtotal" />
                            </div>
                            <div class="summary-item">
                                <div class="label">Descuento</div>
                                <div class="value" id="lblDescuento">$0.00</div>
                            </div>
                            <div class="summary-item">
                                <div class="label"><small class="text-muted">IVA 21% (desglosado)</small></div>
                                <div class="value text-muted" id="lblIVA">$0.00</div>
                                <input type="hidden" id="ivaRate" value="@ViewBag.IvaRate" />
                                <input type="hidden" asp-for="IVA" id="hiddenIVA" />
                            </div>
                            <div class="summary-item totales-destacado">
                                <div class="label">Total</div>
                                <div class="value" id="lblTotal">$0.00</div>
                                <input type="hidden" asp-for="Total" id="hiddenTotal" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mb-4">
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle" aria-hidden="true"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save" aria-hidden="true"></i> Actualizar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<div id="venta-edit-data"
     class="d-none"
     data-detalles='@Html.Raw(Json.Serialize(Model.Detalles.Select(d => new
     {
         index = d.Id,
         d.ProductoId,
         d.ProductoCodigo,
         d.ProductoNombre,
         d.Cantidad,
         d.PrecioUnitario,
         d.Descuento,
         d.Subtotal,
         d.Id
     })))'>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/venta-common.js" asp-append-version="true"></script>
    <script src="~/js/venta-edit.js" asp-append-version="true"></script>
}
