@model TheBuryProject.ViewModels.VentaViewModel
@{
    ViewData["Title"] = "Editar Venta";
}

<section class="container-fluid px-0">
    <div class="col-lg-12 mx-auto">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="bi bi-pencil text-warning me-2"></i> Editar Venta</h2>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>

        <!-- Formulario principal -->
        <form asp-action="Edit" method="post" id="formVenta" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="Numero" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

            <!-- Datos generales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i> Datos de la Venta</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="ClienteId" class="form-label fw-semibold"></label>
                            <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.Clientes">
                                <option value="">Seleccione un cliente...</option>
                            </select>
                            <span asp-validation-for="ClienteId" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="FechaVenta" class="form-label fw-semibold"></label>
                            <input asp-for="FechaVenta" class="form-control" type="date" />
                            <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="TipoPago" class="form-label fw-semibold"></label>
                            <select asp-for="TipoPago" class="form-select" asp-items="ViewBag.TiposPago"></select>
                            <span asp-validation-for="TipoPago" class="text-danger small"></span>
                        </div>

                        <div class="col-md-2">
                            <label asp-for="Descuento" class="form-label fw-semibold"></label>
                            <input asp-for="Descuento" class="form-control" type="number" step="0.01" />
                            <span asp-validation-for="Descuento" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="VendedorNombre" class="form-label fw-semibold"></label>
                            <input asp-for="VendedorNombre" class="form-control" />
                            <span asp-validation-for="VendedorNombre" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Observaciones" class="form-label fw-semibold"></label>
                            <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Observaciones" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financiamiento -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-warning-subtle d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-warning"><i class="bi bi-cash-stack me-2"></i> Financiamiento</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleFinanciado" @(Model.EsFinanciada ? "checked" : string.Empty) />
                        <label class="form-check-label" for="toggleFinanciado">Venta financiada</label>
                    </div>
                </div>
                <div class="card-body">
                    <input asp-for="EsFinanciada" type="hidden" id="EsFinanciada" />

                    <div id="financiamientoCampos" class="@(Model.EsFinanciada ? string.Empty : "d-none")">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label asp-for="Anticipo" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Anticipo" class="form-control" type="number" step="0.01" min="0" id="anticipoInput" />
                                </div>
                                <span asp-validation-for="Anticipo" class="text-danger small"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="TasaInteresMensualFinanciacion" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <input asp-for="TasaInteresMensualFinanciacion" class="form-control" type="number" step="0.01" min="0" max="100" id="tasaMensualInput" />
                                    <span class="input-group-text">%</span>
                                </div>
                                <span class="form-text">Tasa mensual como porcentaje.</span>
                                <span asp-validation-for="TasaInteresMensualFinanciacion" class="text-danger small"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="CantidadCuotasFinanciacion" class="form-label fw-semibold"></label>
                                <input asp-for="CantidadCuotasFinanciacion" class="form-control" type="number" min="1" max="120" id="cuotasFinanciacionInput" />
                                <span asp-validation-for="CantidadCuotasFinanciacion" class="text-danger small"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="IngresoNetoDeclarado" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="IngresoNetoDeclarado" class="form-control" type="number" step="0.01" min="0" id="ingresoNetoInput" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="EndeudamientoDeclarado" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="EndeudamientoDeclarado" class="form-control" type="number" step="0.01" min="0" id="otrasDeudasInput" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="AntiguedadLaboralMeses" class="form-label fw-semibold"></label>
                                <input asp-for="AntiguedadLaboralMeses" class="form-control" type="number" min="0" id="antiguedadLaboralInput" />
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded">
                                    <p class="text-muted mb-1">Monto financiado</p>
                                    <h4 id="lblMontoFinanciadoEstimado" class="mb-0">$0.00</h4>
                                    <input asp-for="MontoFinanciadoEstimado" type="hidden" id="MontoFinanciadoEstimado" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded">
                                    <p class="text-muted mb-1">Cuota estimada</p>
                                    <h4 id="lblCuotaEstimada" class="mb-0 text-success">$0.00</h4>
                                    <input asp-for="CuotaEstimada" type="hidden" id="CuotaEstimada" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded h-100">
                                    <p class="text-muted mb-2">Semáforo preliminar</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <span id="badgeSemaforo" class="badge bg-secondary">Sin datos</span>
                                        <span id="mensajeSemaforo" class="text-muted small">Completa los datos para precalificar.</span>
                                    </div>
                                    <div id="flagsSemaforo" class="mt-2 small text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-info"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">Producto</label>
                            <select id="productoSelect" class="form-select" asp-items="ViewBag.Productos">
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Cantidad</label>
                            <input type="number" id="cantidadInput" class="form-control" value="1" min="1" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Precio</label>
                            <input type="number" id="precioInput" class="form-control" step="0.01" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Descuento</label>
                            <input type="number" id="descuentoInput" class="form-control" value="0" step="0.01" />
                        </div>
                        <div class="col-md-1">
                            <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tablaDetalles">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Descuento</th>
                                    <th>Subtotal</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="detallesBody">
                                @foreach (var detalle in Model.Detalles)
                                {
                                    <tr data-index="@detalle.Id">
                                        <td>@detalle.ProductoNombre</td>
                                        <td>@detalle.Cantidad</td>
                                        <td>$@detalle.PrecioUnitario.ToString("F2")</td>
                                        <td>$@detalle.Descuento.ToString("F2")</td>
                                        <td>$@detalle.Subtotal.ToString("F2")</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarDetalle(@detalle.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row justify-content-end">
                        <div class="col-md-5">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <th class="text-muted">Subtotal:</th>
                                    <td class="text-end"><span id="subtotalDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Descuento:</th>
                                    <td class="text-end"><span id="descuentoDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">IVA (@(((decimal)ViewBag.IvaRate * 100).ToString("0"))%):</th>
                                    <td class="text-end"><span id="ivaDisplay">$0.00</span></td>
                                </tr>
                                <tr class="table-dark">
                                    <th>TOTAL:</th>
                                    <th class="text-end text-success"><span id="totalDisplay">$0.00</span></th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden inputs -->
            <input type="hidden" asp-for="Subtotal" id="subtotalHidden" />
            <input type="hidden" id="ivaRate" value="@ViewBag.IvaRate" />
            <input type="hidden" asp-for="IVA" id="ivaHidden" />
            <input type="hidden" asp-for="Total" id="totalHidden" />

            <!-- Botones -->
            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-warning px-4">
                    <i class="bi bi-save"></i> Actualizar Venta
                </button>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let detalles = @Html.Raw(Json.Serialize(Model.Detalles.Select(d => new {
            index = d.Id,
            ProductoId = d.ProductoId,
            ProductoNombre = d.ProductoNombre,
            Cantidad = d.Cantidad,
            PrecioUnitario = d.PrecioUnitario,
            Descuento = d.Descuento,
            Subtotal = d.Subtotal,
            Id = d.Id
        })));

        let detalleIndex = detalles.length ? Math.max(...detalles.map(d => d.index)) + 1 : 1;
        let recalculoFinanciamientoEnCurso = false;
        const ivaRate = parseFloat(document.getElementById('ivaRate').value.replace(',', '.')) || 0;

        $(document).ready(function () {
            calcularTotales();

            $('#toggleFinanciado').on('change', function () {
                const activo = $(this).is(':checked');
                $('#EsFinanciada').val(activo);
                $('#financiamientoCampos').toggleClass('d-none', !activo);

                if (activo) {
                    recalcularFinanciamiento();
                } else {
                    limpiarResumenFinanciamiento();
                }
            });

            $('#EsFinanciada').val($('#toggleFinanciado').is(':checked'));
            if ($('#toggleFinanciado').is(':checked')) {
                recalcularFinanciamiento();
            }

            $('#anticipoInput, #tasaMensualInput, #cuotasFinanciacionInput, #ingresoNetoInput, #otrasDeudasInput, #antiguedadLaboralInput')
                .on('input change', function () {
                    if ($('#toggleFinanciado').is(':checked')) {
                        recalcularFinanciamiento();
                    }
                });

            $('#productoSelect').change(function () {
                const productoId = $(this).val();
                if (productoId) {
                    $.get('@Url.Action("GetPrecioProducto", "VentaApi")', { id: productoId }, function (data) {
                        $('#precioInput').val(data.precioVenta.toFixed(2));
                    });
                }
            });

            $('#btnAgregarProducto').click(function () {
                const productoId = $('#productoSelect').val();
                const productoTexto = $('#productoSelect option:selected').text();
                const cantidad = parseFloat($('#cantidadInput').val());
                const precio = parseFloat($('#precioInput').val());
                const descuento = parseFloat($('#descuentoInput').val()) || 0;

                if (!productoId || cantidad <= 0 || precio <= 0) {
                    alert('Complete todos los campos correctamente.');
                    return;
                }

                const subtotal = (cantidad * precio) - descuento;

                const detalle = {
                    index: detalleIndex++,
                    ProductoId: productoId,
                    ProductoNombre: productoTexto,
                    Cantidad: cantidad,
                    PrecioUnitario: precio,
                    Descuento: descuento,
                    Subtotal: subtotal,
                    Id: 0
                };

                detalles.push(detalle);
                agregarFilaDetalle(detalle);
                calcularTotales();

                $('#productoSelect').val('');
                $('#cantidadInput').val(1);
                $('#precioInput').val('');
                $('#descuentoInput').val(0);
            });

            $('#formVenta').submit(function () {
                $('input[name^="Detalles"]').remove();
                detalles.forEach((detalle, index) => {
                    $(this).append(`
                        <input type="hidden" name="Detalles[${index}].ProductoId" value="${detalle.ProductoId}" />
                        <input type="hidden" name="Detalles[${index}].Cantidad" value="${detalle.Cantidad}" />
                        <input type="hidden" name="Detalles[${index}].PrecioUnitario" value="${detalle.PrecioUnitario}" />
                        <input type="hidden" name="Detalles[${index}].Descuento" value="${detalle.Descuento}" />
                        <input type="hidden" name="Detalles[${index}].Subtotal" value="${detalle.Subtotal}" />
                    `);
                });
            });

            $('#Descuento').on('input', calcularTotales);
        });

        function agregarFilaDetalle(detalle) {
            $('#detallesBody').append(`
                <tr data-index="${detalle.index}">
                    <td>${detalle.ProductoNombre}</td>
                    <td>${detalle.Cantidad}</td>
                    <td>$${detalle.PrecioUnitario.toFixed(2)}</td>
                    <td>$${detalle.Descuento.toFixed(2)}</td>
                    <td>$${detalle.Subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="eliminarDetalle(${detalle.index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
        }

        function eliminarDetalle(index) {
            detalles = detalles.filter(d => d.index !== index);
            $(`tr[data-index="${index}"]`).remove();
            calcularTotales();
        }

        function limpiarResumenFinanciamiento() {
            $('#MontoFinanciadoEstimado').val('');
            $('#CuotaEstimada').val('');
            $('#lblMontoFinanciadoEstimado').text('$0.00');
            $('#lblCuotaEstimada').text('$0.00');
            actualizarSemaforo(null);
        }

        function recalcularFinanciamiento() {
            if (recalculoFinanciamientoEnCurso) {
                return;
            }

            const total = parseFloat($('#totalHidden').val()) || 0;
            const anticipo = parseFloat($('#anticipoInput').val()) || 0;
            const tasa = (parseFloat($('#tasaMensualInput').val()) || 0) / 100;
            const cuotas = parseInt($('#cuotasFinanciacionInput').val()) || 0;

            if (total <= 0 || cuotas < 1) {
                limpiarResumenFinanciamiento();
                return;
            }

            recalculoFinanciamientoEnCurso = true;
            $('#badgeSemaforo').removeClass('bg-success bg-warning bg-danger').addClass('bg-secondary').text('Calculando...');

            const token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("CalcularFinanciamiento", "Venta")',
                type: 'POST',
                contentType: 'application/json',
                headers: { 'RequestVerificationToken': token },
                data: JSON.stringify({
                    total: total,
                    anticipo: anticipo,
                    tasaMensual: tasa,
                    cuotas: cuotas,
                    ingresoNeto: parseFloat($('#ingresoNetoInput').val()) || null,
                    otrasDeudas: parseFloat($('#otrasDeudasInput').val()) || null,
                    antiguedadLaboralMeses: parseInt($('#antiguedadLaboralInput').val()) || null
                })
            })
                .done(function (data) {
                    $('#MontoFinanciadoEstimado').val(data.financedAmount.toFixed(2));
                    $('#CuotaEstimada').val(data.installment.toFixed(2));
                    $('#lblMontoFinanciadoEstimado').text(`$${data.financedAmount.toFixed(2)}`);
                    $('#lblCuotaEstimada').text(`$${data.installment.toFixed(2)}`);
                    actualizarSemaforo(data.prequalification);
                })
                .fail(function (xhr) {
                    const error = xhr.responseJSON?.error || 'No se pudo calcular el financiamiento';
                    actualizarSemaforo(null, error);
                })
                .always(function () {
                    recalculoFinanciamientoEnCurso = false;
                });
        }

        function actualizarSemaforo(resultado, error) {
            const badge = $('#badgeSemaforo');
            const mensaje = $('#mensajeSemaforo');
            const flags = $('#flagsSemaforo');

            badge.removeClass('bg-success bg-warning bg-danger bg-secondary');

            if (error) {
                badge.addClass('bg-danger').text('Error');
                mensaje.text(error);
                flags.text('');
                return;
            }

            if (!resultado) {
                badge.addClass('bg-secondary').text('Sin datos');
                mensaje.text('Completa los datos para precalificar.');
                flags.text('');
                return;
            }

            let label = 'Indeterminado';
            let badgeClass = 'bg-secondary';

            switch (resultado.status) {
                case 1:
                    label = 'Verde';
                    badgeClass = 'bg-success';
                    mensaje.text('Capacidad validada con política 30%.');
                    break;
                case 2:
                    label = 'Amarillo';
                    badgeClass = 'bg-warning';
                    mensaje.text(resultado.recomendacion || 'Revisar datos adicionales.');
                    break;
                case 3:
                    label = 'Rojo';
                    badgeClass = 'bg-danger';
                    mensaje.text(resultado.recomendacion || 'No cumple política.');
                    break;
                default:
                    mensaje.text('Completa los datos para precalificar.');
                    break;
            }

            badge.addClass(badgeClass).text(label);

            if (resultado.flags && resultado.flags.length > 0) {
                flags.text(resultado.flags.join(' • '));
            } else {
                flags.text('');
            }
        }

        function calcularTotales() {
            const subtotal = detalles.reduce((sum, d) => sum + d.Subtotal, 0);
            const descuentoGlobal = parseFloat($('#Descuento').val()) || 0;
            const subtotalConDescuento = subtotal - descuentoGlobal;
            const iva = subtotalConDescuento * ivaRate;
            const total = subtotalConDescuento + iva;

            $('#subtotalDisplay').text('$' + subtotal.toFixed(2));
            $('#descuentoDisplay').text('$' + descuentoGlobal.toFixed(2));
            $('#ivaDisplay').text('$' + iva.toFixed(2));
            $('#totalDisplay').text('$' + total.toFixed(2));

            $('#subtotalHidden').val(subtotal.toFixed(2));
            $('#ivaHidden').val(iva.toFixed(2));
            $('#totalHidden').val(total.toFixed(2));

            if ($('#toggleFinanciado').is(':checked')) {
                recalcularFinanciamiento();
            }
        }
    </script>
}
