@model TheBuryProject.ViewModels.VentaViewModel
@{
    ViewData["Title"] = "Editar Venta";
}

<section class="container-fluid px-0">
    <div class="col-lg-12 mx-auto">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="bi bi-pencil text-warning me-2"></i> Editar Venta</h2>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>

        <!-- Formulario principal -->
        <form asp-action="Edit" method="post" id="formVenta" novalidate>
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="Numero" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

            <!-- Datos generales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i> Datos de la Venta</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="ClienteId" class="form-label fw-semibold"></label>
                            <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.Clientes">
                                <option value="">Seleccione un cliente...</option>
                            </select>
                            <span asp-validation-for="ClienteId" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="FechaVenta" class="form-label fw-semibold"></label>
                            <input asp-for="FechaVenta" class="form-control" type="date" />
                            <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="TipoPago" class="form-label fw-semibold"></label>
                            <select asp-for="TipoPago" class="form-select" asp-items="ViewBag.TiposPago"></select>
                            <span asp-validation-for="TipoPago" class="text-danger small"></span>
                        </div>

                        <div class="col-md-2">
                            <label asp-for="Descuento" class="form-label fw-semibold"></label>
                            <input asp-for="Descuento" class="form-control" type="number" step="0.01" />
                            <span asp-validation-for="Descuento" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="VendedorNombre" class="form-label fw-semibold"></label>
                            <input asp-for="VendedorNombre" class="form-control" />
                            <span asp-validation-for="VendedorNombre" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Observaciones" class="form-label fw-semibold"></label>
                            <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Observaciones" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-info"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">Producto</label>
                            <select id="productoSelect" class="form-select" asp-items="ViewBag.Productos">
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Cantidad</label>
                            <input type="number" id="cantidadInput" class="form-control" value="1" min="1" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Precio</label>
                            <input type="number" id="precioInput" class="form-control" step="0.01" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Descuento</label>
                            <input type="number" id="descuentoInput" class="form-control" value="0" step="0.01" />
                        </div>
                        <div class="col-md-1">
                            <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tablaDetalles">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Descuento</th>
                                    <th>Subtotal</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="detallesBody">
                                @foreach (var detalle in Model.Detalles)
                                {
                                    <tr data-index="@detalle.Id">
                                        <td>@detalle.ProductoNombre</td>
                                        <td>@detalle.Cantidad</td>
                                        <td>$@detalle.PrecioUnitario.ToString("F2")</td>
                                        <td>$@detalle.Descuento.ToString("F2")</td>
                                        <td>$@detalle.Subtotal.ToString("F2")</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarDetalle(@detalle.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row justify-content-end">
                        <div class="col-md-5">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <th class="text-muted">Subtotal:</th>
                                    <td class="text-end"><span id="subtotalDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Descuento:</th>
                                    <td class="text-end"><span id="descuentoDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">IVA (21%):</th>
                                    <td class="text-end"><span id="ivaDisplay">$0.00</span></td>
                                </tr>
                                <tr class="table-dark">
                                    <th>TOTAL:</th>
                                    <th class="text-end text-success"><span id="totalDisplay">$0.00</span></th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden inputs -->
            <input type="hidden" asp-for="Subtotal" id="subtotalHidden" />
            <input type="hidden" asp-for="IVA" id="ivaHidden" />
            <input type="hidden" asp-for="Total" id="totalHidden" />

            <!-- Botones -->
            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-warning px-4">
                    <i class="bi bi-save"></i> Actualizar Venta
                </button>
            </div>
        </form>
    </div>
</section>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let detalles = @Html.Raw(Json.Serialize(Model.Detalles.Select(d => new {
            index = d.Id,
            ProductoId = d.ProductoId,
            ProductoNombre = d.ProductoNombre,
            Cantidad = d.Cantidad,
            PrecioUnitario = d.PrecioUnitario,
            Descuento = d.Descuento,
            Subtotal = d.Subtotal,
            Id = d.Id
        })));

        let detalleIndex = detalles.length ? Math.max(...detalles.map(d => d.index)) + 1 : 1;

        $(document).ready(function () {
            calcularTotales();

            $('#productoSelect').change(function () {
                const productoId = $(this).val();
                if (productoId) {
                    $.get('@Url.Action("GetProductoPrecio", "Venta")', { productoId: productoId }, function (data) {
                        $('#precioInput').val(data.precioVenta.toFixed(2));
                    });
                }
            });

            $('#btnAgregarProducto').click(function () {
                const productoId = $('#productoSelect').val();
                const productoTexto = $('#productoSelect option:selected').text();
                const cantidad = parseFloat($('#cantidadInput').val());
                const precio = parseFloat($('#precioInput').val());
                const descuento = parseFloat($('#descuentoInput').val()) || 0;

                if (!productoId || cantidad <= 0 || precio <= 0) {
                    alert('Complete todos los campos correctamente.');
                    return;
                }

                const subtotal = (cantidad * precio) - descuento;

                const detalle = {
                    index: detalleIndex++,
                    ProductoId: productoId,
                    ProductoNombre: productoTexto,
                    Cantidad: cantidad,
                    PrecioUnitario: precio,
                    Descuento: descuento,
                    Subtotal: subtotal,
                    Id: 0
                };

                detalles.push(detalle);
                agregarFilaDetalle(detalle);
                calcularTotales();

                $('#productoSelect').val('');
                $('#cantidadInput').val(1);
                $('#precioInput').val('');
                $('#descuentoInput').val(0);
            });

            $('#formVenta').submit(function () {
                $('input[name^="Detalles"]').remove();
                detalles.forEach((detalle, index) => {
                    $(this).append(`
                        <input type="hidden" name="Detalles[${index}].ProductoId" value="${detalle.ProductoId}" />
                        <input type="hidden" name="Detalles[${index}].Cantidad" value="${detalle.Cantidad}" />
                        <input type="hidden" name="Detalles[${index}].PrecioUnitario" value="${detalle.PrecioUnitario}" />
                        <input type="hidden" name="Detalles[${index}].Descuento" value="${detalle.Descuento}" />
                        <input type="hidden" name="Detalles[${index}].Subtotal" value="${detalle.Subtotal}" />
                    `);
                });
            });

            $('#Descuento').on('input', calcularTotales);
        });

        function agregarFilaDetalle(detalle) {
            $('#detallesBody').append(`
                <tr data-index="${detalle.index}">
                    <td>${detalle.ProductoNombre}</td>
                    <td>${detalle.Cantidad}</td>
                    <td>$${detalle.PrecioUnitario.toFixed(2)}</td>
                    <td>$${detalle.Descuento.toFixed(2)}</td>
                    <td>$${detalle.Subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="eliminarDetalle(${detalle.index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
        }

        function eliminarDetalle(index) {
            detalles = detalles.filter(d => d.index !== index);
            $(`tr[data-index="${index}"]`).remove();
            calcularTotales();
        }

        function calcularTotales() {
            const subtotal = detalles.reduce((sum, d) => sum + d.Subtotal, 0);
            const descuentoGlobal = parseFloat($('#Descuento').val()) || 0;
            const subtotalConDescuento = subtotal - descuentoGlobal;
            const iva = subtotalConDescuento * 0.21;
            const total = subtotalConDescuento + iva;

            $('#subtotalDisplay').text('$' + subtotal.toFixed(2));
            $('#descuentoDisplay').text('$' + descuentoGlobal.toFixed(2));
            $('#ivaDisplay').text('$' + iva.toFixed(2));
            $('#totalDisplay').text('$' + total.toFixed(2));

            $('#subtotalHidden').val(subtotal.toFixed(2));
            $('#ivaHidden').val(iva.toFixed(2));
            $('#totalHidden').val(total.toFixed(2));
        }
    </script>
}
