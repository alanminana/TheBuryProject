@model TheBuryProject.ViewModels.VentaViewModel
@{
    ViewData["Title"] = "Editar Venta";
}

<section class="container-fluid px-0">
    <div class="col-lg-12 mx-auto">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="bi bi-pencil text-warning me-2"></i> Editar Venta</h2>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>

        <!-- Formulario principal -->
        <form asp-action="Edit" method="post" id="formVenta" novalidate
              data-get-precio-producto-url="@Url.Action("GetPrecioProducto", "VentaApi")"
              data-calcular-financiamiento-url="@Url.Action("CalcularFinanciamiento", "Venta")">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="Numero" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

            <!-- Datos generales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i> Datos de la Venta</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label asp-for="ClienteId" class="form-label fw-semibold"></label>
                            <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.Clientes">
                                <option value="">Seleccione un cliente...</option>
                            </select>
                            <span asp-validation-for="ClienteId" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="FechaVenta" class="form-label fw-semibold"></label>
                            <input asp-for="FechaVenta" class="form-control" type="date" />
                            <span asp-validation-for="FechaVenta" class="text-danger small"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="TipoPago" class="form-label fw-semibold"></label>
                            <select asp-for="TipoPago" class="form-select" asp-items="ViewBag.TiposPago"></select>
                            <span asp-validation-for="TipoPago" class="text-danger small"></span>
                        </div>

                        <div class="col-md-2">
                            <label asp-for="Descuento" class="form-label fw-semibold"></label>
                            <input asp-for="Descuento" class="form-control" type="number" step="0.01" />
                            <span asp-validation-for="Descuento" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="VendedorNombre" class="form-label fw-semibold"></label>
                            <input asp-for="VendedorNombre" class="form-control" />
                            <span asp-validation-for="VendedorNombre" class="text-danger small"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Observaciones" class="form-label fw-semibold"></label>
                            <textarea asp-for="Observaciones" class="form-control" rows="2"></textarea>
                            <span asp-validation-for="Observaciones" class="text-danger small"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financiamiento -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-warning-subtle d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-warning"><i class="bi bi-cash-stack me-2"></i> Financiamiento</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleFinanciado" @(Model.EsFinanciada ? "checked" : string.Empty) />
                        <label class="form-check-label" for="toggleFinanciado">Venta financiada</label>
                    </div>
                </div>
                <div class="card-body">
                    <input asp-for="EsFinanciada" type="hidden" id="EsFinanciada" />

                    <div id="financiamientoCampos" class="@(Model.EsFinanciada ? string.Empty : "d-none")">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label asp-for="Anticipo" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Anticipo" class="form-control" type="number" step="0.01" min="0" id="anticipoInput" />
                                </div>
                                <span asp-validation-for="Anticipo" class="text-danger small"></span>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="TasaInteresMensualFinanciacion" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <input asp-for="TasaInteresMensualFinanciacion" class="form-control" type="number" step="0.01" min="0" max="100" id="tasaMensualInput" />
                                    <span class="input-group-text">%</span>
                                </div>
                                <span class="form-text">Tasa mensual como porcentaje.</span>
                                <span asp-validation-for="TasaInteresMensualFinanciacion" class="text-danger small"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="CantidadCuotasFinanciacion" class="form-label fw-semibold"></label>
                                <input asp-for="CantidadCuotasFinanciacion" class="form-control" type="number" min="1" max="120" id="cuotasFinanciacionInput" />
                                <span asp-validation-for="CantidadCuotasFinanciacion" class="text-danger small"></span>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="IngresoNetoDeclarado" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="IngresoNetoDeclarado" class="form-control" type="number" step="0.01" min="0" id="ingresoNetoInput" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="EndeudamientoDeclarado" class="form-label fw-semibold"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="EndeudamientoDeclarado" class="form-control" type="number" step="0.01" min="0" id="otrasDeudasInput" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label asp-for="AntiguedadLaboralMeses" class="form-label fw-semibold"></label>
                                <input asp-for="AntiguedadLaboralMeses" class="form-control" type="number" min="0" id="antiguedadLaboralInput" />
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded">
                                    <p class="text-muted mb-1">Monto financiado</p>
                                    <h4 id="lblMontoFinanciadoEstimado" class="mb-0">$0.00</h4>
                                    <input asp-for="MontoFinanciadoEstimado" type="hidden" id="MontoFinanciadoEstimado" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded">
                                    <p class="text-muted mb-1">Cuota estimada</p>
                                    <h4 id="lblCuotaEstimada" class="mb-0 text-success">$0.00</h4>
                                    <input asp-for="CuotaEstimada" type="hidden" id="CuotaEstimada" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 bg-light border rounded h-100">
                                    <p class="text-muted mb-2">Semáforo preliminar</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <span id="badgeSemaforo" class="badge bg-secondary">Sin datos</span>
                                        <span id="mensajeSemaforo" class="text-muted small">Completa los datos para precalificar.</span>
                                    </div>
                                    <div id="flagsSemaforo" class="mt-2 small text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-surface-soft border-bottom border-dark-subtle">
                    <h5 class="mb-0 text-info"><i class="bi bi-box-seam me-2"></i> Productos</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">Producto</label>
                            <select id="productoSelect" class="form-select" asp-items="ViewBag.Productos">
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Cantidad</label>
                            <input type="number" id="cantidadInput" class="form-control" value="1" min="1" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Precio</label>
                            <input type="number" id="precioInput" class="form-control" step="0.01" readonly />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Descuento</label>
                            <input type="number" id="descuentoInput" class="form-control" value="0" step="0.01" />
                        </div>
                        <div class="col-md-1">
                            <button type="button" id="btnAgregarProducto" class="btn btn-success w-100">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tablaDetalles">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Descuento</th>
                                    <th>Subtotal</th>
                                    <th class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="detallesBody">
                                @foreach (var detalle in Model.Detalles)
                                {
                                    <tr data-index="@detalle.Id">
                                        <td>@detalle.ProductoNombre</td>
                                        <td>@detalle.Cantidad</td>
                                        <td>$@detalle.PrecioUnitario.ToString("F2")</td>
                                        <td>$@detalle.Descuento.ToString("F2")</td>
                                        <td>$@detalle.Subtotal.ToString("F2")</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger btn-eliminar-detalle" data-index="@detalle.Id">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row justify-content-end">
                        <div class="col-md-5">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <th class="text-muted">Subtotal:</th>
                                    <td class="text-end"><span id="subtotalDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">Descuento:</th>
                                    <td class="text-end"><span id="descuentoDisplay">$0.00</span></td>
                                </tr>
                                <tr>
                                    <th class="text-muted">IVA (@(((decimal)ViewBag.IvaRate * 100).ToString("0"))%):</th>
                                    <td class="text-end"><span id="ivaDisplay">$0.00</span></td>
                                </tr>
                                <tr class="table-dark">
                                    <th>TOTAL:</th>
                                    <th class="text-end text-success"><span id="totalDisplay">$0.00</span></th>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden inputs -->
            <input type="hidden" asp-for="Subtotal" id="subtotalHidden" />
            <input type="hidden" id="ivaRate" value="@ViewBag.IvaRate" />
            <input type="hidden" asp-for="IVA" id="ivaHidden" />
            <input type="hidden" asp-for="Total" id="totalHidden" />

            <!-- Botones -->
            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-warning px-4">
                    <i class="bi bi-save"></i> Actualizar Venta
                </button>
            </div>
        </form>
    </div>
</section>

<div id="venta-edit-data"
     class="d-none"
     data-detalles='@Html.Raw(Json.Serialize(Model.Detalles.Select(d => new
     {
         index = d.Id,
         d.ProductoId,
         d.ProductoNombre,
         d.Cantidad,
         d.PrecioUnitario,
         d.Descuento,
         d.Subtotal,
         d.Id
     })))'>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/venta-edit.js" asp-append-version="true"></script>
}
