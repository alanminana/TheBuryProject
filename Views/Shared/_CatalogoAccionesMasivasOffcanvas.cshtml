@*
    Offcanvas para acciones masivas de precios.
    Flujo: Alcance → Regla → Preview → Confirmar
*@

<!-- Offcanvas: Acciones Masivas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAccionesMasivas" 
     aria-labelledby="offcanvasAccionesMasivasLabel" style="width: 600px;">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title" id="offcanvasAccionesMasivasLabel">
            <i class="bi bi-currency-dollar me-2"></i>Cambio Masivo de Precios
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    
    <div class="offcanvas-body p-0">
        <!-- Indicador de Pasos -->
        <div class="bg-light border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="step-indicator" data-step="1">
                    <span class="badge rounded-pill bg-primary step-number">1</span>
                    <span class="step-label small">Alcance</span>
                </div>
                <div class="flex-grow-1 border-top mx-2"></div>
                <div class="step-indicator" data-step="2">
                    <span class="badge rounded-pill bg-secondary step-number">2</span>
                    <span class="step-label small text-muted">Regla</span>
                </div>
                <div class="flex-grow-1 border-top mx-2"></div>
                <div class="step-indicator" data-step="3">
                    <span class="badge rounded-pill bg-secondary step-number">3</span>
                    <span class="step-label small text-muted">Preview</span>
                </div>
                <div class="flex-grow-1 border-top mx-2"></div>
                <div class="step-indicator" data-step="4">
                    <span class="badge rounded-pill bg-secondary step-number">4</span>
                    <span class="step-label small text-muted">Confirmar</span>
                </div>
            </div>
        </div>

        <!-- Contenedor de Pasos -->
        <div class="steps-container p-4">
            
            <!-- PASO 1: Alcance -->
            <div class="step-content" id="step1" style="display: block;">
                <h6 class="mb-3">
                    <i class="bi bi-funnel me-2"></i>¿A qué productos aplicar?
                </h6>
                
                <div class="mb-3">
                    <label class="form-label">Nombre del cambio <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="nombreCambio" 
                           placeholder="Ej: Aumento inflación Enero 2025" required>
                </div>

                <!-- Eliminado selector de listas de precios -->

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Categorías</label>
                        <select class="form-select" id="categorias" multiple size="4">
                            @* Se poblará dinámicamente *@
                        </select>
                        <div class="form-text">Vacío = todas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Marcas</label>
                        <select class="form-select" id="marcas" multiple size="4">
                            @* Se poblará dinámicamente *@
                        </select>
                        <div class="form-text">Vacío = todas</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Productos específicos (IDs)</label>
                    <input type="text" class="form-control" id="productosIds" 
                           placeholder="Ej: 1,5,12,23 (vacío = todos según filtros arriba)">
                    <div class="form-text">Separados por coma. Si se especifican, ignora categorías/marcas.</div>
                </div>
            </div>

            <!-- PASO 2: Regla -->
            <div class="step-content" id="step2" style="display: none;">
                <h6 class="mb-3">
                    <i class="bi bi-calculator me-2"></i>¿Cómo calcular el nuevo precio?
                </h6>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Cambio</label>
                    <select class="form-select" id="tipoCambio">
                        <option value="porcentaje" selected>Porcentaje sobre precio actual</option>
                        <option value="porcentajecosto">Porcentaje sobre costo</option>
                        <option value="absoluto">Valor absoluto (suma/resta)</option>
                        <option value="directo">Asignación directa</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Valor del Cambio <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="valorCambio" 
                               step="0.01" placeholder="Ej: 10 para +10%, -5 para -5%" required>
                        <span class="input-group-text" id="valorSuffix">%</span>
                    </div>
                    <div class="form-text">
                        <strong>Positivo = aumento</strong>, <strong>negativo = descuento</strong>
                    </div>
                </div>

                <div class="alert alert-info" id="ejemploCalculo">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Ejemplo:</strong> Con +10% sobre un precio de $1,000 → nuevo precio: $1,100
                </div>
            </div>

            <!-- PASO 3: Preview -->
            <div class="step-content" id="step3" style="display: none;">
                <h6 class="mb-3">
                    <i class="bi bi-eye me-2"></i>Vista previa del cambio
                </h6>

                <!-- Métricas -->
                <div class="row mb-3">
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <div class="fs-4 fw-bold" id="previewTotal">0</div>
                                <small class="text-muted">Productos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-success bg-opacity-10">
                            <div class="card-body p-2 text-center">
                                <div class="fs-4 fw-bold text-success" id="previewAumentos">0</div>
                                <small class="text-muted">Aumentos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-danger bg-opacity-10">
                            <div class="card-body p-2 text-center">
                                <div class="fs-4 fw-bold text-danger" id="previewDescuentos">0</div>
                                <small class="text-muted">Descuentos</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spinner de carga -->
                <div id="previewLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Calculando...</span>
                    </div>
                    <p class="mt-2 text-muted">Simulando cambios...</p>
                </div>

                <!-- Tabla de preview -->
                <div id="previewTableContainer" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Producto</th>
                                <th class="text-end">Actual</th>
                                <th class="text-end">Nuevo</th>
                                <th class="text-end">Dif.</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Filas dinámicas -->
                        </tbody>
                    </table>
                </div>

                <!-- Alerta de autorización -->
                <div class="alert alert-warning mt-3" id="alertaAutorizacion" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Requiere autorización:</strong> Este cambio supera los umbrales configurados.
                </div>
            </div>

            <!-- PASO 4: Confirmar -->
            <div class="step-content" id="step4" style="display: none;">
                <h6 class="mb-3">
                    <i class="bi bi-check-circle me-2"></i>Confirmar aplicación
                </h6>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>¡Atención!</strong> Esta acción aplicará los cambios de forma permanente.
                    <ul class="mb-0 mt-2">
                        <li>Se creará historial de precios</li>
                        <li>Se registrará auditoría del cambio</li>
                        <li>Los cambios son reversibles desde el historial</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <label class="form-label">Fecha de Vigencia</label>
                    <input type="date" class="form-control" id="fechaVigencia">
                    <div class="form-text">Vacío = aplicar inmediatamente</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Notas (opcional)</label>
                    <textarea class="form-control" id="notasCambio" rows="2" 
                              placeholder="Motivo o comentarios adicionales..."></textarea>
                </div>

                <!-- Resumen final -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Resumen</h6>
                        <dl class="row mb-0 small">
                            <dt class="col-5">Nombre:</dt>
                            <dd class="col-7" id="resumenNombre">-</dd>
                            <dt class="col-5">Tipo:</dt>
                            <dd class="col-7" id="resumenTipo">-</dd>
                            <dt class="col-5">Valor:</dt>
                            <dd class="col-7" id="resumenValor">-</dd>
                            <dt class="col-5">Productos:</dt>
                            <dd class="col-7" id="resumenProductos">-</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Resultado de aplicación -->
            <div class="step-content" id="stepResultado" style="display: none;">
                <div class="text-center py-4">
                    <div id="resultadoExito" style="display: none;">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">¡Cambios aplicados correctamente!</h5>
                        <p class="text-muted" id="resultadoMensaje"></p>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="offcanvas">
                            Cerrar
                        </button>
                    </div>
                    <div id="resultadoError" style="display: none;">
                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">Error al aplicar cambios</h5>
                        <p class="text-muted" id="errorMensaje"></p>
                        <button type="button" class="btn btn-secondary" id="btnVolverPreview">
                            Volver al preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer con botones de navegación -->
    <div class="offcanvas-footer border-top p-3 bg-light">
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" id="btnAnterior" style="display: none;">
                <i class="bi bi-arrow-left me-1"></i>Anterior
            </button>
            <div class="ms-auto">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="offcanvas">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnSiguiente">
                    Siguiente<i class="bi bi-arrow-right ms-1"></i>
                </button>
                <button type="button" class="btn btn-success" id="btnAplicar" style="display: none;">
                    <i class="bi bi-check-lg me-1"></i>Aplicar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .step-indicator {
        text-align: center;
        min-width: 60px;
    }
    .step-indicator .step-number {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .step-indicator.active .step-number {
        background-color: var(--bs-primary) !important;
    }
    .step-indicator.completed .step-number {
        background-color: var(--bs-success) !important;
    }
    .step-indicator.active .step-label,
    .step-indicator.completed .step-label {
        color: inherit !important;
    }
    .offcanvas-footer {
        position: sticky;
        bottom: 0;
    }
    #previewTableContainer::-webkit-scrollbar {
        width: 6px;
    }
    #previewTableContainer::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 3px;
    }
</style>

            <!-- Modal de confirmación antes de aplicar -->
            <div class="modal fade" id="modalConfirmarAplicarCambio" tabindex="-1" aria-labelledby="modalConfirmarAplicarCambioLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-dark text-light">
                        <div class="modal-header bg-success text-white border-0">
                            <h5 class="modal-title" id="modalConfirmarAplicarCambioLabel">
                                <i class="bi bi-check-lg me-2"></i>Confirmar Aplicación de Cambio
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <strong>Resumen:</strong>
                                <ul class="list-unstyled mb-0">
                                    <li><span class="fw-semibold">Alcance:</span> <span id="resumenAlcance"></span></li>
                                    <li><span class="fw-semibold">Cantidad de productos:</span> <span id="resumenCantidad"></span></li>
                                    <li><span class="fw-semibold">Cambio %:</span> <span id="resumenPorcentaje"></span></li>
                                    <li><span class="fw-semibold">Motivo:</span> <span id="resumenMotivo"></span></li>
                                </ul>
                            </div>
                            <div class="alert alert-warning small mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                ¿Está seguro de aplicar el cambio de precios? Esta acción se registrará y podrá revertirse desde el historial.
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="btnConfirmarAplicarCambio">
                                <i class="bi bi-check-lg me-1"></i>Confirmar y Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
