@model TheBuryProject.ViewModels.AlertaStockViewModel

@{
    ViewData["Title"] = "Detalle de Alerta";
}

<section class="container-fluid px-0 py-3 text-light">

    <!-- Header de página -->
    <div class="d-flex align-items-start justify-content-between mb-4">
        <div>
            <div class="text-muted text-uppercase small mb-1">Alertas de stock</div>
            <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-bell" aria-hidden="true"></i>
                <span>Detalle de alerta</span>
            </h1>
            <p class="text-muted small mb-0">
                Información detallada de la alerta y del producto afectado.
            </p>
        </div>

        <div class="d-flex flex-wrap gap-2">
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>Volver
            </a>
        </div>
    </div>

    <div class="row g-3">

        <!-- COLUMNA IZQUIERDA -->
        <div class="col-12 col-lg-8">

            <!-- Información de la Alerta -->
            <div class="card card-animate mb-3">
                <div class="card-header @Model.BadgeTipo">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="h6 mb-0 text-white d-flex align-items-center gap-2">
                            <i class="@Model.IconoTipo" aria-hidden="true"></i>
                            <span>@Model.TipoDescripcion</span>
                        </h2>
                        <span class="badge bg-dark">@Model.PrioridadDescripcion</span>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <small class="form-label text-muted d-block">Estado</small>
                            <span class="badge @Model.BadgeEstado fs-6">
                                @Model.EstadoDescripcion
                            </span>
                        </div>
                        <div class="col-md-6">
                            <small class="form-label text-muted d-block">Fecha de alerta</small>
                            <div>
                                <i class="bi bi-calendar" aria-hidden="true"></i>
                                <time datetime="@Model.FechaAlerta.ToString("yyyy-MM-ddTHH:mm:ss")">
                                    @Model.FechaAlerta.ToString("dd/MM/yyyy HH:mm")
                                </time>
                            </div>
                            <div class="small text-muted">
                                Hace @Model.DiasDesdeAlerta día(s)
                            </div>
                        </div>
                    </div>

                    @if (Model.EstaVencida)
                    {
                        <div class="alert alert-danger mb-2" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
                            <strong>Alerta vencida.</strong>
                            Esta alerta lleva más de 7 días sin resolverse.
                        </div>
                    }

                    @if (Model.NotificacionUrgente)
                    {
                        <div class="alert alert-warning mb-3" role="alert">
                            <i class="bi bi-bell-fill me-2" aria-hidden="true"></i>
                            <strong>Notificación urgente.</strong>
                            Requiere atención inmediata.
                        </div>
                    }

                    <div class="mb-3">
                        <small class="form-label text-muted d-block">Mensaje</small>
                        <p class="lead mb-0">@Model.Mensaje</p>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Model.Observaciones))
                    {
                        <div class="mt-3">
                            <small class="form-label text-muted d-block">Observaciones</small>
                            <p class="mb-0">@Model.Observaciones</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Información del Producto -->
            <div class="card card-animate mb-3">
                <div class="card-header bg-primary text-white">
                    <h2 class="h6 mb-0 d-flex align-items-center gap-2">
                        <i class="bi bi-box" aria-hidden="true"></i>
                        <span>Información del producto</span>
                    </h2>
                </div>

                <div class="card-body">
                    <h3 class="h5 mb-2 d-flex align-items-center gap-2 flex-wrap">
                        <span class="badge bg-secondary">@Model.ProductoCodigo</span>
                        <span>@Model.ProductoNombre</span>
                    </h3>

                    <p class="text-muted mb-3">
                        <small>
                            <i class="bi bi-tag" aria-hidden="true"></i> @Model.CategoriaNombre
                        </small>
                    </p>

                    <hr class="my-3" />

                    <div class="row text-center mb-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <h3 class="mb-0 @(Model.StockActual == 0 ? "text-danger" : Model.StockActual <= (Model.StockMinimo * 0.3m) ? "text-warning" : "text-secondary")">
                                @Model.StockActual.ToString("N0")
                            </h3>
                            <small class="text-muted d-block">Stock actual</small>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <h3 class="mb-0 text-primary">
                                @Model.StockMinimo.ToString("N0")
                            </h3>
                            <small class="text-muted d-block">Stock mínimo</small>
                        </div>
                        <div class="col-md-4">
                            <h3 class="mb-0 text-info">
                                @Model.PorcentajeStockMinimo.ToString("N0")%
                            </h3>
                            <small class="text-muted d-block">% del mínimo</small>
                        </div>
                    </div>

                    @if (Model.CantidadSugeridaReposicion.HasValue)
                    {
                        <div class="alert alert-info mb-3" role="note">
                            <h4 class="h6 mb-2">
                                <i class="bi bi-lightbulb me-1" aria-hidden="true"></i>
                                Reposición sugerida
                            </h4>
                            <h2 class="h5 mb-1">
                                +@Model.CantidadSugeridaReposicion.Value.ToString("N0") unidades
                            </h2>
                            <small class="text-muted">
                                Stock objetivo: @((Model.StockMinimo * 3).ToString("N0")) unidades.
                            </small>
                        </div>
                    }

                    <div class="mt-3">
                        <a asp-controller="Producto"
                           asp-action="Details"
                           asp-route-id="@Model.ProductoId"
                           class="btn btn-outline-info w-100 mb-2">
                            <i class="bi bi-eye me-1" aria-hidden="true"></i>Ver detalles del producto
                        </a>
                        <a asp-controller="Producto"
                           asp-action="Edit"
                           asp-route-id="@Model.ProductoId"
                           class="btn btn-primary w-100">
                            <i class="bi bi-pencil me-1" aria-hidden="true"></i>Editar producto
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="col-12 col-lg-4">

            <!-- Acciones / Resolución -->
            @if (Model.Estado == TheBuryProject.Models.Enums.EstadoAlerta.Pendiente)
            {
                <div class="card card-animate mb-3">
                    <div class="card-header bg-success text-white">
                        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-check-circle" aria-hidden="true"></i>
                            <span>Acciones</span>
                        </h2>
                    </div>
                    <div class="card-body">
                        <form asp-action="Resolver" asp-route-id="@Model.Id" method="post" class="mb-3">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="rowVersion" value="@(Model.RowVersion != null ? Convert.ToBase64String(Model.RowVersion) : "")" />
                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                            <div class="mb-3">
                                <label class="form-label" for="resolverObservaciones">Observaciones (opcional)</label>
                                <textarea name="observaciones"
                                          id="resolverObservaciones"
                                          class="form-control"
                                          rows="3"
                                          placeholder="Ej: Stock repuesto mediante orden de compra #123"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-check-circle me-1" aria-hidden="true"></i>Resolver alerta
                            </button>
                        </form>

                        <hr class="my-3" />

                        <form asp-action="Ignorar" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="rowVersion" value="@(Model.RowVersion != null ? Convert.ToBase64String(Model.RowVersion) : "")" />
                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                            <div class="mb-3">
                                <label class="form-label" for="ignorarObservaciones">Motivo (opcional)</label>
                                <textarea name="observaciones"
                                          id="ignorarObservaciones"
                                          class="form-control"
                                          rows="3"
                                          placeholder="Ej: Producto descontinuado"></textarea>
                            </div>
                            <button type="submit"
                                    class="btn btn-outline-secondary w-100"
                                    data-confirm="¿Está seguro de ignorar esta alerta?">
                                <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Ignorar alerta
                            </button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card card-animate mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
                            <i class="bi bi-info-circle" aria-hidden="true"></i>
                            <span>Resolución</span>
                        </h2>
                    </div>
                    <div class="card-body">
                        @if (Model.FechaResolucion.HasValue)
                        {
                            <p class="mb-2">
                                <strong>Fecha:</strong><br />
                                <time datetime="@Model.FechaResolucion.Value.ToString("yyyy-MM-ddTHH:mm:ss")">
                                    @Model.FechaResolucion.Value.ToString("dd/MM/yyyy HH:mm")
                                </time>
                            </p>
                        }

                        @if (!string.IsNullOrWhiteSpace(Model.UsuarioResolucion))
                        {
                            <p class="mb-2">
                                <strong>Usuario:</strong><br />
                                <i class="bi bi-person" aria-hidden="true"></i> @Model.UsuarioResolucion
                            </p>
                        }

                        @if (!string.IsNullOrWhiteSpace(Model.Observaciones))
                        {
                            <p class="mb-0">
                                <strong>Observaciones:</strong><br />
                                @Model.Observaciones
                            </p>
                        }
                    </div>
                </div>
            }

            <!-- Estadísticas rápidas -->
            <div class="card card-animate">
                <div class="card-header bg-info text-white">
                    <h2 class="h6 mb-0 d-flex align-items-center gap-2">
                        <i class="bi bi-graph-up" aria-hidden="true"></i>
                        <span>Datos adicionales</span>
                    </h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block">Prioridad</small>
                        <span class="badge @Model.BadgePrioridad mt-1">
                            @Model.PrioridadDescripcion
                        </span>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block">Tipo de alerta</small>
                        <span class="badge @Model.BadgeTipo mt-1">
                            <i class="@Model.IconoTipo" aria-hidden="true"></i> @Model.TipoDescripcion
                        </span>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted d-block">Días desde creación</small>
                        <h4 class="mb-0 @(Model.EstaVencida ? "text-danger" : "")">
                            @Model.DiasDesdeAlerta
                        </h4>
                    </div>

                    @if (Model.NotificacionUrgente)
                    {
                        <div class="alert alert-warning mb-0" role="alert">
                            <i class="bi bi-bell-fill me-1" aria-hidden="true"></i>
                            Urgente
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

@*
MEJORAS (solo HTML/markup):
- Fechas en <time datetime="..."> (semántica/machine-readable).
- Íconos con aria-hidden="true".
- role="alert"/role="note" en alerts informativos.
- Jerarquía de encabezados más consistente (h1 → h2/h3).
*@
