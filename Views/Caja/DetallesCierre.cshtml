@model TheBuryProject.Models.Entities.CierreCaja

@{
    ViewData["Title"] = "Detalles del Cierre";
}

@section Styles {
    <link rel="stylesheet" href="~/css/caja.css" asp-append-version="true" />
}

<section class="container-fluid py-4 text-light">

    <!-- Header de página -->
    <div class="row align-items-start justify-content-between mb-4 page-toolbar-print g-3">
        <div class="col">
            <div class="text-muted text-uppercase small mb-1">Cajas</div>
            <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-file-text"></i>
                <span>Comprobante de cierre de caja</span>
            </h1>
            <p class="text-muted small mb-0">
                Resumen del cierre, arqueo físico y diferencias registradas para la caja seleccionada.
            </p>
        </div>

        <div class="col-auto d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary btn-sm" id="imprimirCierre">
                <i class="bi bi-printer me-1"></i>Imprimir
            </button>
            @{
                var returnUrl = ViewBag.ReturnUrl as string;
            }
            @if (!string.IsNullOrWhiteSpace(returnUrl) && Url.IsLocalUrl(returnUrl) && returnUrl.Contains("/Caja/DetallesApertura", StringComparison.OrdinalIgnoreCase))
            {
                <a href="@returnUrl" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Volver a la apertura
                </a>
            }
            @if (!string.IsNullOrWhiteSpace(returnUrl) && Url.IsLocalUrl(returnUrl) && returnUrl.Contains("/Caja/Historial", StringComparison.OrdinalIgnoreCase))
            {
                <a href="@returnUrl" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-clock-history me-1"></i>Ver historial
                </a>
            }
            else
            {
                <a asp-action="Historial" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-clock-history me-1"></i>Ver historial
                </a>
            }
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Volver al listado
            </a>
        </div>
    </div>

    <div class="card bg-dark border-0 shadow-sm card-animate">
        <div class="card-body">

            <!-- Encabezado del comprobante -->
            <div class="text-center mb-4">
                <h2 class="h4 mb-1">COMPROBANTE DE CIERRE DE CAJA</h2>
                <p class="text-muted small mb-0">
                    Fecha de cierre:
                    <strong>@Model.FechaCierre.ToString("dd/MM/yyyy HH:mm")</strong>
                </p>
            </div>

            <!-- Información general -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card bg-dark border-0 h-100 shadow-sm">
                        <div class="card-body">
                            <h2 class="h6 text-uppercase text-muted mb-3">Información de la caja</h2>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover align-middle mb-0">
                                    <tbody class="small">
                                        <tr>
                                            <td class="text-muted w-25">Caja</td>
                                            <td>
                                                <strong>
                                                    @Model.AperturaCaja.Caja.Nombre (@Model.AperturaCaja.Caja.Codigo)
                                                </strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Sucursal</td>
                                            <td>@(Model.AperturaCaja.Caja.Sucursal ?? "-")</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Ubicación</td>
                                            <td>@(Model.AperturaCaja.Caja.Ubicacion ?? "-")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card bg-dark border-0 h-100 shadow-sm">
                        <div class="card-body">
                            <h2 class="h6 text-uppercase text-muted mb-3">Información del turno</h2>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover align-middle mb-0">
                                    <tbody class="small">
                                        <tr>
                                            <td class="text-muted w-35">Apertura</td>
                                            <td>
                                                @Model.AperturaCaja.FechaApertura.ToString("dd/MM/yyyy HH:mm")
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Cierre</td>
                                            <td>
                                                @Model.FechaCierre.ToString("dd/MM/yyyy HH:mm")
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Usuario apertura</td>
                                            <td>@Model.AperturaCaja.UsuarioApertura</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Usuario cierre</td>
                                            <td>@Model.UsuarioCierre</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-secondary-subtle" />

            <!-- Datos del sistema -->
            <div class="mb-3">
                <h2 class="h6 text-uppercase text-muted mb-3">Datos del sistema</h2>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Monto inicial</small>
                                <h5 class="mb-0 text-primary">
                                    @Model.MontoInicialSistema.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Total ingresos</small>
                                <h5 class="mb-0 text-success">
                                    @Model.TotalIngresosSistema.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Total egresos</small>
                                <h5 class="mb-0 text-danger">
                                    @Model.TotalEgresosSistema.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-info bg-opacity-25 h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Monto esperado</small>
                                <h5 class="mb-0 text-info">
                                    @Model.MontoEsperadoSistema.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Arqueo físico -->
            <div class="mt-4 mb-3">
                <h2 class="h6 text-uppercase text-muted mb-3">Arqueo físico</h2>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Efectivo</small>
                                <h5 class="mb-0">
                                    @Model.EfectivoContado.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Cheques</small>
                                <h5 class="mb-0">
                                    @Model.ChequesContados.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-dark h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Vales / otros</small>
                                <h5 class="mb-0">
                                    @Model.ValesContados.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 bg-primary bg-opacity-25 h-100 shadow-sm">
                            <div class="card-body text-center py-3">
                                <small class="text-muted text-uppercase d-block mb-1">Total real</small>
                                <h5 class="mb-0 text-primary">
                                    @Model.MontoTotalReal.ToString("C")
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Diferencia -->
            <div class="mt-4 mb-4">
                @{
                    var diffCardClass = Model.TieneDiferencia
                    ? (Model.Diferencia > 0 ? "border-success" : "border-danger")
                    : "border-success";
                    var diffTextClass = Model.TieneDiferencia
                    ? (Model.Diferencia > 0 ? "text-success" : "text-danger")
                    : "text-success";
                }
                <div class="card bg-dark border-0 shadow-sm @diffCardClass">
                    <div class="card-body text-center">
                        <h2 class="h6 text-uppercase text-muted mb-2">Diferencia</h2>

                        @if (Model.TieneDiferencia)
                        {
                            <h2 class="@diffTextClass mb-1">
                                @(Model.Diferencia > 0 ? "+" : "")@Model.Diferencia.ToString("C")
                            </h2>
                            @if (Model.Diferencia > 0)
                            {
                                <p class="text-success mb-0 small">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Sobrante
                                </p>
                            }
                            else
                            {
                                <p class="text-danger mb-0 small">
                                    <i class="bi bi-arrow-down-circle me-1"></i>Faltante
                                </p>
                            }
                        }
                        else
                        {
                            <h2 class="text-success mb-1">
                                <i class="bi bi-check-circle me-1"></i>$0,00
                            </h2>
                            <p class="text-success mb-0 small">Cierre exacto</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Justificación de diferencia -->
            @if (Model.TieneDiferencia && !string.IsNullOrWhiteSpace(Model.JustificacionDiferencia))
            {
                <div class="alert alert-warning mb-4">
                    <h2 class="h6 mb-2 d-flex align-items-center gap-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>Justificación de diferencia</span>
                    </h2>
                    <p class="mb-0 small">@Model.JustificacionDiferencia</p>
                </div>
            }

            <!-- Detalle de arqueo -->
            @if (!string.IsNullOrWhiteSpace(Model.DetalleArqueo))
            {
                <div class="mb-4">
                    <h2 class="h6 text-uppercase text-muted mb-2">Detalle de billetes y monedas</h2>
                    <div class="card bg-dark border-0 shadow-sm">
                        <div class="card-body">
                            <pre class="mb-0 small">@Model.DetalleArqueo</pre>
                        </div>
                    </div>
                </div>
            }

            <!-- Observaciones del cierre -->
            @if (!string.IsNullOrWhiteSpace(Model.ObservacionesCierre))
            {
                <div class="mb-4">
                    <h2 class="h6 text-uppercase text-muted mb-2">Observaciones del cierre</h2>
                    <div class="card bg-dark border-0 shadow-sm">
                        <div class="card-body">
                            <p class="mb-0 small">@Model.ObservacionesCierre</p>
                        </div>
                    </div>
                </div>
            }

            <!-- Resumen de movimientos -->
            <div class="mb-4">
                <h2 class="h6 text-uppercase text-muted mb-2">Resumen de movimientos</h2>
                <div class="card bg-dark border-0 shadow-sm">
                    <div class="card-body small">
                        <p class="mb-1">
                            <strong>Total de movimientos:</strong>
                            @Model.AperturaCaja.Movimientos.Count
                        </p>
                        <p class="mb-1">
                            <strong>Ingresos:</strong>
                            @Model.AperturaCaja.Movimientos.Count(m => m.Tipo == TheBuryProject.Models.Enums.TipoMovimientoCaja.Ingreso)
                        </p>
                        <p class="mb-0">
                            <strong>Egresos:</strong>
                            @Model.AperturaCaja.Movimientos.Count(m => m.Tipo == TheBuryProject.Models.Enums.TipoMovimientoCaja.Egreso)
                        </p>
                    </div>
                </div>
            </div>

            <!-- Firmas -->
            <div class="row mt-5 pt-4">
                <div class="col-md-6 text-center mb-4 mb-md-0">
                    <hr />
                    <p class="mb-0 small"><strong>Firma usuario apertura</strong></p>
                    <small class="text-muted">@Model.AperturaCaja.UsuarioApertura</small>
                </div>
                <div class="col-md-6 text-center">
                    <hr />
                    <p class="mb-0 small"><strong>Firma usuario cierre</strong></p>
                    <small class="text-muted">@Model.UsuarioCierre</small>
                </div>
                </div>

        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/caja-detalles-cierre.js" asp-append-version="true"></script>
}
