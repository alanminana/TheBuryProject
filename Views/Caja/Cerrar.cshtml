@model TheBuryProject.ViewModels.CerrarCajaViewModel

@{
    ViewData["Title"] = "Cerrar Caja";
    var returnUrl = ViewBag.ReturnUrl as string;
}

<div class="container-fluid px-0" data-monto-esperado="@Model.MontoEsperadoSistema.ToString(System.Globalization.CultureInfo.InvariantCulture)">

    <!-- Header de página -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <div class="text-muted text-uppercase small mb-1">Cajas</div>
            <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <span>Cerrar caja · Arqueo</span>
            </h1>
            <p class="text-muted small mb-0">
                Realiza el arqueo de caja, valida diferencias y deja registrado el cierre.
            </p>
        </div>

        @if (!string.IsNullOrWhiteSpace(returnUrl) && Url.IsLocalUrl(returnUrl) && returnUrl.Contains("/Caja/DetallesApertura", StringComparison.OrdinalIgnoreCase))
        {
            <a href="@returnUrl" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Volver a la apertura
            </a>
        }
        else
        {
            <a asp-action="DetallesApertura"
               asp-route-id="@Model.AperturaCajaId"
               class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Volver a la apertura
            </a>
        }
    </div>

    <div class="row">
        <div class="col-12 col-xxl-10">

            <div class="card card-animate">
                <div class="card-body">

                    <!-- Información de la apertura -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-info-circle me-2"></i>
                            <h2 class="h6 mb-0">Información de apertura</h2>
                        </div>
                        <div class="row small">
                            <div class="col-md-4 mb-1">
                                <span class="text-muted">Caja</span><br />
                                <strong>@Model.CajaNombre</strong>
                            </div>
                            <div class="col-md-4 mb-1">
                                <span class="text-muted">Usuario apertura</span><br />
                                <strong>@Model.UsuarioApertura</strong>
                            </div>
                            <div class="col-md-4 mb-1">
                                <span class="text-muted">Fecha apertura</span><br />
                                <strong>@Model.FechaApertura?.ToString("dd/MM/yyyy HH:mm")</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen del sistema -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="card border-0 bg-dark bg-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted text-uppercase small mb-1">Monto inicial</h6>
                                    <h4 class="mb-0 text-primary">
                                        @Model.MontoInicialSistema.ToString("C")
                                    </h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card border-0 bg-dark bg-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted text-uppercase small mb-1">Total ingresos</h6>
                                    <h4 class="mb-0 text-success">
                                        @Model.TotalIngresosSistema.ToString("C")
                                    </h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card border-0 bg-dark bg-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted text-uppercase small mb-1">Total egresos</h6>
                                    <h4 class="mb-0 text-danger">
                                        @Model.TotalEgresosSistema.ToString("C")
                                    </h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card border-0 bg-success bg-opacity-25 h-100">
                                <div class="card-body text-center py-3">
                                    <h6 class="text-muted text-uppercase small mb-1">Monto esperado</h6>
                                    <h4 class="mb-0 text-success">
                                        @Model.MontoEsperadoSistema.ToString("C")
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form asp-action="Cerrar" method="post" novalidate>
                        @Html.AntiForgeryToken()

                        @if (!string.IsNullOrWhiteSpace(returnUrl) && Url.IsLocalUrl(returnUrl))
                        {
                            <input type="hidden" name="returnUrl" value="@returnUrl" />
                        }

                        <input type="hidden" asp-for="AperturaCajaId" />
                        <input type="hidden" asp-for="MontoInicialSistema" />
                        <input type="hidden" asp-for="TotalIngresosSistema" />
                        <input type="hidden" asp-for="TotalEgresosSistema" />
                        <input type="hidden" asp-for="MontoEsperadoSistema" />

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                        <h2 class="h6 mb-3 d-flex align-items-center gap-2">
                            <i class="bi bi-calculator"></i>
                            <span>Arqueo de caja (conteo físico)</span>
                        </h2>

                        <!-- Conteo físico -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="EfectivoContado" class="form-label"></label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="EfectivoContado"
                                           type="number"
                                           step="0.01"
                                           min="0"
                                           class="form-control"
                                           placeholder="0,00"
                                           id="efectivoInput" />
                                </div>
                                <span asp-validation-for="EfectivoContado" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="ChequesContados" class="form-label"></label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="ChequesContados"
                                           type="number"
                                           step="0.01"
                                           min="0"
                                           class="form-control"
                                           placeholder="0,00"
                                           id="chequesInput" />
                                </div>
                                <span asp-validation-for="ChequesContados" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="ValesContados" class="form-label"></label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="ValesContados"
                                           type="number"
                                           step="0.01"
                                           min="0"
                                           class="form-control"
                                           placeholder="0,00"
                                           id="valesInput" />
                                </div>
                                <span asp-validation-for="ValesContados" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Totales y diferencia -->
                        <div class="row mt-3 mb-3">
                            <div class="col-12">
                                <div class="card bg-dark bg-opacity-25">
                                    <div class="card-body">
                                        <div class="row text-center g-3">
                                            <div class="col-md-4">
                                                <h6 class="text-muted text-uppercase small mb-1">Total real</h6>
                                                <h4 id="totalReal" class="mb-0 text-primary">$0,00</h4>
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="text-muted text-uppercase small mb-1">Monto esperado</h6>
                                                <h4 class="mb-0 text-info">
                                                    @Model.MontoEsperadoSistema.ToString("C")
                                                </h4>
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="text-muted text-uppercase small mb-1">Diferencia</h6>
                                                <h4 id="diferencia" class="mb-0 text-warning">$0,00</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Justificación diferencia -->
                        <div class="mb-3" id="justificacionDiv" style="display: none;">
                            <label asp-for="JustificacionDiferencia" class="form-label"></label>
                            <textarea asp-for="JustificacionDiferencia"
                                      class="form-control"
                                      rows="3"
                                      placeholder="OBLIGATORIO: Justifique la diferencia encontrada..."
                                      id="justificacionInput"></textarea>
                            <span asp-validation-for="JustificacionDiferencia" class="text-danger small"></span>
                        </div>

                        <!-- Detalle de arqueo -->
                        <div class="mb-3">
                            <label asp-for="DetalleArqueo" class="form-label"></label>
                            <textarea asp-for="DetalleArqueo"
                                      class="form-control"
                                      rows="4"
                                      placeholder="Opcional: detalle de billetes y monedas contados..."></textarea>
                            <span asp-validation-for="DetalleArqueo" class="text-danger small"></span>
                            <div class="form-text">
                                Ejemplo: 10 billetes de $1000, 5 billetes de $500, 20 monedas de $10...
                            </div>
                        </div>

                        <!-- Observaciones cierre -->
                        <div class="mb-3">
                            <label asp-for="ObservacionesCierre" class="form-label"></label>
                            <textarea asp-for="ObservacionesCierre"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Observaciones del cierre..."></textarea>
                            <span asp-validation-for="ObservacionesCierre" class="text-danger small"></span>
                        </div>

                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Atención.</strong>
                            Verifica cuidadosamente el arqueo. Si hay diferencia, debes justificarla obligatoriamente.
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-end gap-2">
                            <a asp-action="DetallesApertura"
                               asp-route-id="@Model.AperturaCajaId"
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-warning" id="btnCerrar"
                                    data-confirm="¿Cerrar la caja y registrar el arqueo? Esta acción dejará el cierre guardado.">
                                <i class="bi bi-lock me-1"></i>Cerrar caja
                            </button>
                        </div>

                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="~/js/caja-cerrar.js" asp-append-version="true"></script>
}
