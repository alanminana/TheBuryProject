@model TheBuryProject.ViewModels.ClienteDetalleViewModel
@using System.Globalization

<!-- Evaluación Crediticia -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-dark shared-stat-card shadow-sm
                    @(Model.EvaluacionCredito.ScoreCrediticio >= 700
                                     ? "border-success"
                                     : Model.EvaluacionCredito.ScoreCrediticio >= 500
                                         ? "border-warning"
                                         : "border-danger")">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase small mb-2">
                    <i class="bi bi-speedometer2 me-1"></i>Score Crediticio
                </h6>
                <h2 class="fw-bold mb-0
                           @(Model.EvaluacionCredito.ScoreCrediticio >= 700
                                                    ? "text-success"
                                                    : Model.EvaluacionCredito.ScoreCrediticio >= 500
                                                        ? "text-warning"
                                                        : "text-danger")">
                    @Model.EvaluacionCredito.ScoreCrediticio
                </h2>
                <small class="text-muted">Nivel: @Model.EvaluacionCredito.NivelRiesgo</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-dark shared-stat-card shadow-sm
                    @(Model.EvaluacionCredito.MontoMaximoDisponible > 0
                                     ? "border-success"
                                     : "border-warning")">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase small mb-2">
                    <i class="bi bi-cash-stack me-1"></i>Monto Máximo
                </h6>
                <h2 class="fw-bold mb-0
                           @(Model.EvaluacionCredito.MontoMaximoDisponible > 0
                                                    ? "text-success"
                                                    : "text-warning")">
                    @Model.EvaluacionCredito.MontoMaximoDisponible.ToString("C")
                </h2>
                <small class="text-muted">Disponible</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-dark shared-stat-card shadow-sm
                    @(Model.EvaluacionCredito.PorcentajeEndeudamiento < 40
                                     ? "border-success"
                                     : Model.EvaluacionCredito.PorcentajeEndeudamiento < 60
                                         ? "border-warning"
                                         : "border-danger")">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase small mb-2">
                    <i class="bi bi-percent me-1"></i>Endeudamiento
                </h6>
                <h2 class="fw-bold mb-0
                           @(Model.EvaluacionCredito.PorcentajeEndeudamiento < 40
                                                    ? "text-success"
                                                    : Model.EvaluacionCredito.PorcentajeEndeudamiento < 60
                                                        ? "text-warning"
                                                        : "text-danger")">
                    @Model.EvaluacionCredito.PorcentajeEndeudamiento.ToString("F1")%
                </h2>
                <small class="text-muted">de ingresos</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-dark shared-stat-card shadow-sm
                    @(Model.EvaluacionCredito.TieneDocumentosCompletos
                                     ? "border-success"
                                     : "border-warning")">
            <div class="card-body text-center">
                <h6 class="text-secondary text-uppercase small mb-2">
                    <i class="bi bi-file-earmark-check me-1"></i>Documentación
                </h6>
                <h2 class="fw-bold mb-0
                           @(Model.EvaluacionCredito.TieneDocumentosCompletos
                                                    ? "text-success"
                                                    : "text-warning")">
                    @if (Model.EvaluacionCredito.TieneDocumentosCompletos)
                    {
                        <i class="bi bi-check-circle-fill"></i>
                    }
                    else
                    {
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    }
                </h2>
                <small class="text-muted">
                    @(Model.EvaluacionCredito.TieneDocumentosCompletos ? "Completa" : "Incompleta")
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Alertas y Recomendaciones -->
@if (Model.EvaluacionCredito.AlertasYRecomendaciones.Any())
{
    <div class="card bg-dark border-warning shadow-sm mb-3 shared-panel">
        <div class="card-header bg-warning text-dark shared-panel-header">
            <h6 class="mb-0">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Alertas y Recomendaciones
            </h6>
        </div>
        <div class="card-body">
            <ul class="mb-0 text-light">
                @foreach (var alerta in Model.EvaluacionCredito.AlertasYRecomendaciones)
                {
                    <li>@alerta</li>
                }
            </ul>
        </div>
    </div>
}

<!-- Estado de Aprobación -->
@if (!Model.EvaluacionCredito.CumpleRequisitos)
{
    if (Model.EvaluacionCredito.PuedeAprobarConExcepcion)
    {
        <div class="alert alert-warning border-0 shadow-sm">
            <h6 class="alert-heading">
                <i class="bi bi-info-circle-fill me-2"></i>Requiere Aprobación con Excepción
            </h6>
            <p class="mb-0">
                El cliente no cumple con todos los requisitos estándar, pero puede ser aprobado
                con una excepción justificada por un supervisor.
            </p>
        </div>
    }
    else
    {
        <div class="alert alert-danger border-0 shadow-sm">
            <h6 class="alert-heading">
                <i class="bi bi-x-circle-fill me-2"></i>No Cumple Requisitos Mínimos
            </h6>
            <p class="mb-0">
                El cliente no cumple con los requisitos mínimos para solicitar un crédito en este momento.
                Se recomienda completar la documentación y reducir el endeudamiento actual.
            </p>
        </div>
    }
}
else
{
    <div class="alert alert-success border-0 shadow-sm">
        <h6 class="alert-heading">
            <i class="bi bi-check-circle-fill me-2"></i>Cliente Apto para Crédito
        </h6>
        <p class="mb-0">El cliente cumple con todos los requisitos para solicitar un crédito.</p>
    </div>
}

<!-- Formulario de Solicitud -->
<div class="card bg-dark border-0 shadow-sm shared-panel mt-3">
    <div class="card-header bg-secondary shared-panel-header">
        <h5 class="mb-0 text-light">
            <i class="bi bi-currency-dollar me-2"></i>Solicitar Crédito
        </h5>
    </div>
    <div class="card-body">
        <form asp-controller="Cliente" asp-action="SolicitarCredito" method="post" id="formSolicitarCredito" data-capacidad-pago="@Model.EvaluacionCredito.CapacidadPagoMensual.ToString("0.00", CultureInfo.InvariantCulture)" data-calculo-credito-url="@Url.Action("CalcularCreditoPreview", "Cliente")">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ClienteId" value="@Model.Cliente.Id" />

            <div class="row g-3">
                <!-- Monto Solicitado -->
                <div class="col-md-6">
                    <label class="form-label text-light fw-semibold">Monto Solicitado *</label>
                    <div class="input-group">
                        <span class="input-group-text bg-secondary text-light border-0">$</span>
                        <input type="number"
                               name="MontoSolicitado"
                               id="montoSolicitado"
                               class="form-control bg-body-secondary text-light border-0"
                               min="1000"
                               max="@Model.EvaluacionCredito.MontoMaximoDisponible"
                               step="1000"
                               required
                               @(Model.EvaluacionCredito.MontoMaximoDisponible <= 0 ? "disabled" : "") />
                    </div>
                    <div class="form-text text-muted">
                        Máximo disponible: @Model.EvaluacionCredito.MontoMaximoDisponible.ToString("C")
                    </div>
                </div>

                <!-- Cantidad de Cuotas -->
                <div class="col-md-3">
                    <label class="form-label text-light fw-semibold">Cantidad de Cuotas *</label>
                    <select name="CantidadCuotas"
                            id="cantidadCuotas"
                            class="form-select bg-body-secondary text-light border-0"
                            required
                            @(Model.EvaluacionCredito.MontoMaximoDisponible <= 0 ? "disabled" : "")>
                        <option value="3">3 cuotas</option>
                        <option value="6" selected>6 cuotas</option>
                        <option value="12">12 cuotas</option>
                        <option value="18">18 cuotas</option>
                        <option value="24">24 cuotas</option>
                        <option value="36">36 cuotas</option>
                    </select>
                </div>

                <!-- Tasa de Interés -->
                <div class="col-md-3">
                    <label class="form-label text-light fw-semibold">Tasa de Interés % (Mensual) *</label>
                    <input type="number"
                           name="TasaInteres"
                           id="tasaInteres"
                           class="form-control bg-body-secondary text-light border-0"
                           value="5.0"
                           min="0"
                           max="15"
                           step="0.1"
                           required
                           @(Model.EvaluacionCredito.MontoMaximoDisponible <= 0 ? "disabled" : "") />
                </div>

                <!-- Preview de Cuota Mensual -->
                <div class="col-md-12">
                    <div class="card bg-secondary border-0">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">Monto Total con Intereses</small>
                                    <h5 class="text-light mb-0" id="montoTotalConInteres">$0</h5>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Cuota Mensual Estimada</small>
                                    <h5 class="text-success mb-0" id="cuotaMensual">$0</h5>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">Capacidad de Pago</small>
                                    <h5 class="@(Model.EvaluacionCredito.CapacidadPagoMensual > 0 ? "text-info" : "text-warning") mb-0">
                                        @Model.EvaluacionCredito.CapacidadPagoMensual.ToString("C")
                                    </h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="col-md-12">
                    <label class="form-label text-light fw-semibold">Observaciones</label>
                    <textarea name="Observaciones"
                              class="form-control bg-body-secondary text-light border-0"
                              rows="3"
                              placeholder="Observaciones adicionales sobre la solicitud de crédito"></textarea>
                </div>
            </div>

            <!-- Sección de Garante (si es requerido) -->
            @if (Model.EvaluacionCredito.RequiereGarante)
            {
                <hr class="border-secondary my-4" />
                <h6 class="text-light mb-3">
                    <i class="bi bi-person-check text-warning me-1"></i>Información del Garante
                    <span class="badge bg-warning text-dark">Requerido</span>
                </h6>

                @if (Model.EvaluacionCredito.TieneGarante)
                {
                    <div class="alert alert-success border-0 mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        Garante registrado:
                        <strong>@Model.EvaluacionCredito.GaranteNombre</strong>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning border-0 mb-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Se requiere un garante para aprobar este crédito. Ingrese los datos del garante.
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-light fw-semibold">Nombre del Garante *</label>
                            <input type="text"
                                   name="GaranteNombre"
                                   class="form-control bg-body-secondary text-light border-0"
                                   required
                                   placeholder="Nombre completo" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light fw-semibold">Documento *</label>
                            <input type="text"
                                   name="GaranteDocumento"
                                   class="form-control bg-body-secondary text-light border-0"
                                   required
                                   placeholder="DNI del garante" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light fw-semibold">Teléfono *</label>
                            <input type="tel"
                                   name="GaranteTelefono"
                                   class="form-control bg-body-secondary text-light border-0"
                                   required
                                   placeholder="Teléfono de contacto" />
                        </div>
                    </div>
                }
            }

            <!-- Sección de Excepción -->
            @if (!Model.EvaluacionCredito.CumpleRequisitos && Model.EvaluacionCredito.PuedeAprobarConExcepcion)
            {
                <hr class="border-secondary my-4" />
                <h6 class="text-light mb-3">
                    <i class="bi bi-shield-exclamation text-warning me-1"></i>Aprobación con Excepción
                    <span class="badge bg-warning text-dark">Requiere Autorización</span>
                </h6>

                <div class="alert alert-info border-0 mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Esta solicitud requiere aprobación especial debido a que el cliente no cumple con todos los requisitos estándar.
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input"
                           type="checkbox"
                           name="AprobarConExcepcion"
                           id="aprobarConExcepcion"
                           value="true"
                           required />
                    <label class="form-check-label text-light" for="aprobarConExcepcion">
                        Confirmo que este crédito ha sido autorizado con excepción
                    </label>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-light fw-semibold">Motivo de la Excepción *</label>
                        <textarea name="MotivoExcepcion"
                              class="form-control bg-body-secondary text-light border-0"
                              rows="2"
                              required
                              placeholder="Justifique por qué se aprueba este crédito con excepción"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-light fw-semibold">Autorizado Por *</label>
                        <input type="text"
                               name="AutorizadoPor"
                               class="form-control bg-body-secondary text-light border-0"
                               required
                               placeholder="Nombre del supervisor que autoriza" />
                    </div>
                </div>
            }

            <!-- Botones de Acción -->
            <div class="row mt-4">
                <div class="col-md-12">
                    @if (Model.EvaluacionCredito.CumpleRequisitos || Model.EvaluacionCredito.PuedeAprobarConExcepcion)
                    {
                        <button type="submit"
                                class="btn btn-success btn-lg fw-semibold me-2"
                                @(Model.EvaluacionCredito.MontoMaximoDisponible <= 0 ? "disabled" : "")>
                            <i class="bi bi-check-circle me-2"></i>Solicitar Crédito
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-danger btn-lg fw-semibold me-2" disabled>
                            <i class="bi bi-x-circle me-2"></i>No Cumple Requisitos
                        </button>
                    }

                    <a asp-action="Index" class="btn btn-outline-light btn-lg">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/cliente-solicitar-credito.js" asp-append-version="true"></script>
}
