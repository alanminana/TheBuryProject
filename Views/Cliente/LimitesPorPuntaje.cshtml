@model TheBuryProject.ViewModels.ClienteCreditoLimitesViewModel
@using TheBuryProject.Helpers

@{
    ViewData["Title"] = "Límites por puntaje";
    var returnUrl = ViewData["ReturnUrl"] as string;
    var backUrl = returnUrl ?? Url.Action("Index", "Cliente");
    var puedeAdministrarLimites = (ViewBag.PuedeAdministrarLimites as bool?)
        ?? User.TienePermiso("clientes", "managecreditlimits");
}

<section class="container-fluid py-4 text-light">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <partial name="_PageHeader" model='new TheBuryProject.ViewModels.Shared.PageHeaderModel {
                Breadcrumb = "Clientes · Configuración de crédito",
                Title = "Límites de crédito por puntaje",
                Subtitle = "Defina el cupo máximo por nivel de riesgo del cliente.",
                Icon = "sliders",
                BackUrl = backUrl,
                BackText = "Volver"
            }' />

            <partial name="_Alerts" />

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger border-0 shadow-sm">
                    <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
                    Revise los datos ingresados antes de guardar.
                </div>
            }

            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-header bg-secondary text-light">
                    <h5 class="mb-0">
                        <i class="bi bi-table me-2" aria-hidden="true"></i>Configuración de límites
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-secondary mb-3">
                        El crédito disponible se calcula como <strong>Límite - Saldo vigente</strong>.
                    </p>

                    @if (!puedeAdministrarLimites)
                    {
                        <div class="alert alert-info border-0 shadow-sm">
                            <i class="bi bi-eye me-2" aria-hidden="true"></i>
                            Modo solo lectura: no cuenta con permiso para administrar límites de crédito por puntaje.
                        </div>
                    }

                    <form asp-action="LimitesPorPuntaje" method="post" id="formLimitesPuntaje"
                          onsubmit="return confirm('¿Desea guardar la configuración de límites por puntaje?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@returnUrl" />

                        <div class="table-responsive">
                            <table class="table table-dark table-hover align-middle mb-3">
                                <thead class="table-secondary text-dark">
                                    <tr>
                                        <th scope="col" style="width: 35%;">Puntaje</th>
                                        <th scope="col" style="width: 30%;">Límite</th>
                                        <th scope="col" style="width: 15%;" class="text-center">Activo</th>
                                        <th scope="col" style="width: 20%;">Última actualización</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (var i = 0; i < Model.Items.Count; i++)
                                    {
                                        var item = Model.Items[i];
                                        <tr>
                                            <td>
                                                <input asp-for="Items[i].Id" type="hidden" />
                                                <input asp-for="Items[i].Puntaje" type="hidden" />
                                                <span class="badge bg-info me-2">@((int)item.Puntaje)</span>
                                                <span>@item.Puntaje.GetDisplayName()</span>
                                            </td>
                                            <td>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input asp-for="Items[i].LimiteMonto"
                                                           class="form-control"
                                                           min="0"
                                                           step="1"
                                                           inputmode="numeric"
                                                           disabled="@(!puedeAdministrarLimites)"
                                                           aria-label="Límite de crédito" />
                                                </div>
                                                <span asp-validation-for="Items[i].LimiteMonto" class="text-danger small"></span>
                                            </td>
                                            <td class="text-center">
                                                <div class="form-check form-switch d-inline-block m-0">
                                                    <input asp-for="Items[i].Activo" class="form-check-input" disabled="@(!puedeAdministrarLimites)" />
                                                </div>
                                            </td>
                                            <td>
                                                @if (item.FechaActualizacion.HasValue)
                                                {
                                                    <div>@item.FechaActualizacion.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
                                                    <small class="text-secondary">@(!string.IsNullOrWhiteSpace(item.UsuarioActualizacion) ? item.UsuarioActualizacion : "System")</small>
                                                }
                                                else
                                                {
                                                    <span class="text-secondary">Sin cambios</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="@backUrl" class="btn btn-outline-light">
                                <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Cancelar
                            </a>
                            @if (puedeAdministrarLimites)
                            {
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-1" aria-hidden="true"></i>Guardar
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
