@using TheBuryProject.Models.Entities
@model TheBuryProject.ViewModels.CrearSolicitudAutorizacionViewModel

@{
    ViewData["Title"] = "Nueva Solicitud de Autorización";
}

<div class="container-fluid px-0">

    <!-- Header de página -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <div class="text-muted text-uppercase small mb-1">Autorizaciones</div>
            <h1 class="h4 mb-1">Nueva solicitud de autorización</h1>
            <p class="text-muted small mb-0">
                Solicite autorización para exceder los límites configurados para su rol.
            </p>
        </div>

        <a asp-action="Solicitudes" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Volver a solicitudes
        </a>
    </div>

    <!-- Alerta informativa -->
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Información:</strong> Complete este formulario para solicitar autorización cuando una operación
        excede los límites establecidos para su rol. Un supervisor revisará su solicitud.
    </div>

    <div class="row">
        <div class="col-12 col-lg-8 col-xl-6">

            <div class="card card-animate">
                <div class="card-body">

                    <form asp-action="CrearSolicitud" method="post" novalidate>
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>

                        <!-- Tipo de Umbral -->
                        <div class="mb-3">
                            <label asp-for="TipoUmbral" class="form-label"></label>
                            <select asp-for="TipoUmbral"
                                    class="form-select"
                                    asp-items="Html.GetEnumSelectList<TipoUmbral>()"
                                    required>
                                <option value="">Seleccione el tipo de operación...</option>
                            </select>
                            <span asp-validation-for="TipoUmbral" class="text-danger small"></span>
                            <div class="form-text">
                                Seleccione el tipo de límite que necesita exceder.
                            </div>
                        </div>

                        <!-- Tipo de Operación -->
                        <div class="mb-3">
                            <label asp-for="TipoOperacion" class="form-label"></label>
                            <select asp-for="TipoOperacion" class="form-select" required>
                                <option value="">Seleccione...</option>
                                <option value="Venta">Venta</option>
                                <option value="Compra">Compra</option>
                                <option value="Crédito">Crédito</option>
                                <option value="Descuento">Descuento</option>
                                <option value="Ajuste">Ajuste de Stock</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <span asp-validation-for="TipoOperacion" class="text-danger small"></span>
                        </div>

                        <!-- Referencia de Operación -->
                        <div class="mb-3">
                            <label asp-for="ReferenciaOperacionId" class="form-label"></label>
                            <input asp-for="ReferenciaOperacionId"
                                   class="form-control"
                                   type="number"
                                   min="0"
                                   placeholder="ID de la operación (opcional)" />
                            <span asp-validation-for="ReferenciaOperacionId" class="text-danger small"></span>
                            <div class="form-text">
                                Si esta solicitud está relacionada con una operación específica, ingrese su ID.
                            </div>
                        </div>

                        <!-- Valores -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ValorSolicitado" class="form-label"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="ValorSolicitado"
                                           class="form-control"
                                           type="number"
                                           step="0.01"
                                           min="0"
                                           required
                                           placeholder="0.00" />
                                </div>
                                <span asp-validation-for="ValorSolicitado" class="text-danger small d-block"></span>
                                <div class="form-text">
                                    Valor que necesita autorizar.
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="ValorPermitido" class="form-label"></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="ValorPermitido"
                                           class="form-control"
                                           type="number"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00" />
                                </div>
                                <span asp-validation-for="ValorPermitido" class="text-danger small d-block"></span>
                                <div class="form-text">
                                    Valor máximo permitido para su rol (si lo conoce).
                                </div>
                            </div>
                        </div>

                        <!-- Diferencia calculada -->
                        <div class="alert alert-warning mb-3" id="alertDiferencia" style="display: none;">
                            <i class="bi bi-calculator me-2"></i>
                            <strong>Exceso solicitado:</strong> <span id="diferencia">$0.00</span>
                        </div>

                        <!-- Justificación -->
                        <div class="mb-3">
                            <label asp-for="Justificacion" class="form-label"></label>
                            <textarea asp-for="Justificacion"
                                      class="form-control"
                                      rows="4"
                                      minlength="20"
                                      maxlength="1000"
                                      required
                                      placeholder="Explique detalladamente por qué necesita esta autorización..."></textarea>
                            <span asp-validation-for="Justificacion" class="text-danger small"></span>
                            <div class="form-text">
                                Mínimo 20 caracteres. Sea específico sobre el motivo de la solicitud.
                                <span id="charCount" class="float-end">0/1000</span>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a asp-action="Solicitudes" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>Enviar solicitud
                            </button>
                        </div>
                    </form>

                </div>
            </div>

        </div>

        <!-- Panel de ayuda -->
        <div class="col-12 col-lg-4 col-xl-6">
            <div class="card card-animate bg-light">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-question-circle me-2"></i>Ayuda</h6>
                </div>
                <div class="card-body small">
                    <h6 class="fw-semibold">¿Cuándo solicitar autorización?</h6>
                    <ul class="mb-3">
                        <li>Cuando el descuento excede su límite permitido</li>
                        <li>Cuando el monto de venta supera el máximo autorizado</li>
                        <li>Cuando necesita aprobar un crédito mayor al permitido</li>
                        <li>Para cualquier operación que exceda los umbrales de su rol</li>
                    </ul>

                    <h6 class="fw-semibold">Tipos de umbral:</h6>
                    <ul class="mb-3">
                        <li><strong>Descuento en Venta:</strong> % máximo de descuento</li>
                        <li><strong>Monto Total Venta:</strong> Valor máximo por venta</li>
                        <li><strong>Monto Crédito:</strong> Crédito máximo a aprobar</li>
                        <li><strong>Descuento en Compra:</strong> % descuento en compras</li>
                    </ul>

                    <h6 class="fw-semibold">Recomendaciones:</h6>
                    <ul class="mb-0">
                        <li>Sea claro y específico en la justificación</li>
                        <li>Incluya el contexto del cliente o situación</li>
                        <li>Mencione si es un caso excepcional o recurrente</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const valorSolicitado = document.getElementById('ValorSolicitado');
            const valorPermitido = document.getElementById('ValorPermitido');
            const alertDiferencia = document.getElementById('alertDiferencia');
            const diferencia = document.getElementById('diferencia');
            const justificacion = document.getElementById('Justificacion');
            const charCount = document.getElementById('charCount');

            function calcularDiferencia() {
                const solicitado = parseFloat(valorSolicitado.value) || 0;
                const permitido = parseFloat(valorPermitido.value) || 0;

                if (solicitado > 0 && permitido > 0 && solicitado > permitido) {
                    const diff = solicitado - permitido;
                    diferencia.textContent = '$' + diff.toFixed(2);
                    alertDiferencia.style.display = 'block';
                } else {
                    alertDiferencia.style.display = 'none';
                }
            }

            function actualizarContador() {
                const length = justificacion.value.length;
                charCount.textContent = length + '/1000';
                if (length < 20) {
                    charCount.classList.add('text-danger');
                    charCount.classList.remove('text-success');
                } else {
                    charCount.classList.remove('text-danger');
                    charCount.classList.add('text-success');
                }
            }

            if (valorSolicitado && valorPermitido) {
                valorSolicitado.addEventListener('input', calcularDiferencia);
                valorPermitido.addEventListener('input', calcularDiferencia);
            }

            if (justificacion && charCount) {
                justificacion.addEventListener('input', actualizarContador);
                actualizarContador();
            }
        });
    </script>
}
