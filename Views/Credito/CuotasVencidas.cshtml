@model List<TheBuryProject.ViewModels.CuotaViewModel>
@{
    ViewData["Title"] = "Cuotas Vencidas";
    var returnUrl = ViewData["ReturnUrl"] as string;
    var backUrl = returnUrl ?? Url.Action("Index", "Credito")!;
    var listReturnUrl = Context.Request.Path + Context.Request.QueryString;
}

<section class="container-fluid py-4 text-light">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0 text-danger">
            <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>Cuotas Vencidas
        </h2>
        <div>
            <button type="button" class="btn btn-outline-warning me-2" data-bs-toggle="modal" data-bs-target="#modalConfiguracionMora">
                <i class="bi bi-gear-fill me-2" aria-hidden="true"></i>Configuración de mora
            </button>
            <a href="@backUrl" class="btn btn-outline-light">
                <i class="bi bi-arrow-left me-2" aria-hidden="true"></i>Volver a Créditos
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2" aria-hidden="true"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    }

    @if (Model.Any())
    {
        <div class="alert alert-warning bg-opacity-25 border-warning text-light shadow-sm" role="alert">
            <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
            <strong>Total de cuotas vencidas: @Model.Count</strong>
        </div>

        <div class="card bg-dark border-0 shadow-sm">
            <div class="card-header bg-danger text-light py-3">
                <h5 class="fw-bold mb-0">
                    <i class="bi bi-clock-history me-2" aria-hidden="true"></i>Listado de Cuotas Vencidas
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle mb-0">
                        <thead class="bg-secondary text-light">
                            <tr>
                                <th scope="col">Crédito</th>
                                <th scope="col">Cuota N°</th>
                                <th scope="col">Vencimiento</th>
                                <th scope="col">Días Atraso</th>
                                <th scope="col">Monto</th>
                                <th scope="col">Punitorio</th>
                                <th scope="col">Total Adeudado</th>
                                <th scope="col">Estado</th>
                                <th scope="col" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cuota in Model.OrderBy(c => c.FechaVencimiento))
                            {
                                <tr style="border-left: 4px solid @cuota.ColorAlerta;">
                                    <td class="fw-semibold">
                                        <a asp-action="Details" asp-route-id="@cuota.CreditoId" asp-route-returnUrl="@listReturnUrl" class="text-decoration-none text-info">
                                            @cuota.CreditoNumero
                                        </a>
                                        <br />
                                        <small class="text-muted">@cuota.ClienteNombre</small>
                                    </td>
                                    <td><span class="badge bg-secondary">@cuota.NumeroCuota</span></td>
                                    <td><time datetime="@cuota.FechaVencimiento.ToString("yyyy-MM-dd")">@cuota.FechaVencimiento.ToString("dd/MM/yyyy")</time></td>
                                    <td>
                                        <span class="badge" style="background-color: @cuota.ColorAlerta; color: white;">
                                            @cuota.DiasAtraso días
                                        </span>
                                        @if (!string.IsNullOrEmpty(cuota.DescripcionAlerta))
                                        {
                                            <br />
                                            <small class="text-muted">@cuota.DescripcionAlerta</small>
                                        }
                                    </td>
                                    <td>@cuota.MontoTotal.ToString("C2")</td>
                                    <td class="text-danger fw-semibold">@cuota.MontoPunitorio.ToString("C2")</td>
                                    <td class="fw-bold fs-5">@cuota.SaldoPendiente.ToString("C2")</td>
                                    <td>
                                        @switch (cuota.Estado)
                                        {
                                            case TheBuryProject.Models.Enums.EstadoCuota.Vencida:
                                                <span class="badge bg-danger">Vencida</span>
                                                break;
                                            case TheBuryProject.Models.Enums.EstadoCuota.Parcial:
                                                <span class="badge bg-warning text-dark">Parcial</span>
                                                break;
                                            default:
                                                <span class="badge bg-secondary">@cuota.Estado</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="PagarCuota" asp-route-id="@cuota.CreditoId"
                                                              asp-route-cuotaId="@cuota.Id"
                                                              asp-route-returnUrl="@listReturnUrl"
                                               class="btn btn-success text-dark fw-semibold" title="Registrar Pago">
                                                <i class="bi bi-cash-coin" aria-hidden="true"></i> Pagar
                                            </a>
                                                          <a asp-controller="Credito" asp-action="Details" asp-route-id="@cuota.CreditoId" asp-route-returnUrl="@listReturnUrl"
                                               class="btn btn-outline-info" title="Ver Crédito" aria-label="Ver crédito @cuota.CreditoNumero">
                                                <i class="bi bi-eye" aria-hidden="true"></i>
                                                <span class="visually-hidden">Ver crédito</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card bg-dark border-0 shadow-sm text-center py-5">
            <div class="card-body">
                <i class="bi bi-check-circle-fill text-success display-4 mb-3" aria-hidden="true"></i>
                <h4 class="fw-bold">Sin cuotas vencidas</h4>
                <p class="text-secondary mb-3">Todos los pagos están al día.</p>
                <a asp-action="Index" class="btn btn-info text-dark fw-semibold">
                    <i class="bi bi-list-check me-2" aria-hidden="true"></i>Ver Créditos
                </a>
            </div>
        </div>
    }
</section>

@section Modals {
    <!-- Modal Configuración de Mora -->
    <div class="modal fade" id="modalConfiguracionMora" tabindex="-1" aria-labelledby="modalConfiguracionMoraLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold" id="modalConfiguracionMoraLabel">
                        <i class="bi bi-gear-fill me-2 text-warning" aria-hidden="true"></i>Configuración de Mora
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <!-- Configuración Base -->
                    <div class="card bg-secondary bg-opacity-25 border-secondary mb-4">
                        <div class="card-header bg-secondary bg-opacity-50">
                            <h6 class="mb-0"><i class="bi bi-calculator me-2" aria-hidden="true"></i>Configuración de Interés Punitorio</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tasaMoraDiaria" class="form-label">Tasa Diaria (%)</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary" id="tasaMoraDiaria" step="0.0001" min="0" max="100" required>
                                    <small class="text-muted">Porcentaje de interés punitorio por día</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="diasGracia" class="form-label">Días de Gracia</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary" id="diasGracia" min="0" required>
                                    <small class="text-muted">Días antes de aplicar el interés</small>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="procesoAutomaticoActivo">
                                <label class="form-check-label" for="procesoAutomaticoActivo">
                                    Proceso automático activo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas de Mora -->
                    <div class="card bg-secondary bg-opacity-25 border-secondary">
                        <div class="card-header bg-secondary bg-opacity-50 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-bell-fill me-2" aria-hidden="true"></i>Alertas de Mora</h6>
                            <button type="button" class="btn btn-sm btn-success" id="btnAgregarAlerta">
                                <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>Agregar Alerta
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover" id="tablaAlertas">
                                    <thead>
                                        <tr>
                                            <th scope="col" width="20%">Días</th>
                                            <th scope="col" width="25%">Descripción</th>
                                            <th scope="col" width="15%">Color</th>
                                            <th scope="col" width="15%">Prioridad</th>
                                            <th scope="col" width="10%">Activa</th>
                                            <th scope="col" width="15%">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyAlertas">
                                        <!-- Alertas dinámicas -->
                                    </tbody>
                                </table>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                                Días negativos = antes del vencimiento | Días positivos = después del vencimiento | 0 = día del vencimiento
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btnGuardarConfiguracion">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Alerta -->
    <div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modalAlertaLabel">
                        <i class="bi bi-bell-fill me-2" aria-hidden="true"></i><span id="tituloModalAlerta">Agregar Alerta</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="alertaIndex">
                    <div class="mb-3">
                        <label for="alertaDias" class="form-label">Días relativos al vencimiento</label>
                        <input type="number" class="form-control bg-dark text-light border-secondary" id="alertaDias" required>
                        <small class="text-muted">Negativo = antes | Positivo = después | 0 = día de vencimiento</small>
                    </div>
                    <div class="mb-3">
                        <label for="alertaDescripcion" class="form-label">Descripción</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="alertaDescripcion" maxlength="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="alertaColor" class="form-label">Color de Alerta</label>
                        <div class="input-group">
                            <input type="color" class="form-control form-control-color bg-dark border-secondary" id="alertaColor" value="#ff0000">
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="alertaColorHex" value="#FF0000" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="alertaPrioridad" class="form-label">Nivel de Prioridad</label>
                        <select class="form-select bg-dark text-light border-secondary" id="alertaPrioridad" required>
                            <option value="1">1 - Baja</option>
                            <option value="2">2 - Media-Baja</option>
                            <option value="3" selected>3 - Media</option>
                            <option value="4">4 - Media-Alta</option>
                            <option value="5">5 - Alta</option>
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="alertaActiva" checked>
                        <label class="form-check-label" for="alertaActiva">
                            Alerta activa
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btnGuardarAlerta">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/mora-config-modal.js"></script>
}
