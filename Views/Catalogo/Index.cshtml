@model TheBuryProject.ViewModels.CatalogoUnificadoViewModel

@{
    ViewData["Title"] = "Catálogo";
    var returnUrl = Context.Request.Path + Context.Request.QueryString;
}

<section class="container-fluid py-4">

    @* Header *@
    <div class="row align-items-center mb-4">
        <div class="col">
            <div class="text-muted text-uppercase small mb-1">Inventario · Catálogo Unificado</div>
            <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-grid text-primary"></i>
                <span>Catálogo de Productos</span>
            </h1>
            <p class="text-secondary small mb-0">
                Consultá y gestioná productos, precios según lista y stock desde un único lugar.
            </p>
        </div>
        <div class="col-auto d-flex flex-wrap gap-2">
            @* Acceso rápido a Categorías y Marcas *@
            <a asp-controller="Categoria" asp-action="Index" asp-route-returnUrl="@returnUrl"
               class="btn btn-outline-primary fw-semibold shadow-sm">
                <i class="bi bi-diagram-3 me-2"></i>Categorías
                <span class="badge bg-primary ms-1">@Model.TotalCategorias</span>
            </a>
            <a asp-controller="Marca" asp-action="Index" asp-route-returnUrl="@returnUrl"
               class="btn btn-outline-success fw-semibold shadow-sm">
                <i class="bi bi-award me-2"></i>Marcas
                <span class="badge bg-success ms-1">@Model.TotalMarcas</span>
            </a>

            @* Movimientos de Stock *@
            <a asp-controller="MovimientoStock" asp-action="Index"
               class="btn btn-outline-warning fw-semibold shadow-sm text-dark">
                <i class="bi bi-arrow-left-right me-2"></i>Movimientos Stock
            </a>

            @* Menú secundario con opciones avanzadas *@
            <div class="dropdown">
                <button class="btn btn-outline-secondary fw-semibold shadow-sm dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear me-1"></i>Más opciones
                </button>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                    <li>
                        <a class="dropdown-item" asp-controller="ListasPrecios" asp-action="Index">
                            <i class="bi bi-tags me-2"></i>Administrar Listas de Precios
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-controller="CambiosPrecios" asp-action="Index">
                            <i class="bi bi-clock-history me-2"></i>Historial de cambios masivos
                        </a>
                    </li>
                    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Gerente"))
                    {
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" asp-controller="CambiosPrecios" asp-action="Simular">
                                <i class="bi bi-calculator me-2"></i>Nueva simulación avanzada
                            </a>
                        </li>
                    }
                </ul>
            </div>

            <a asp-controller="Producto" asp-action="Create"
               class="btn btn-primary fw-semibold shadow-sm">
                <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
            </a>
        </div>
    </div>

    @* Alertas unificadas *@
    <partial name="_Alerts" />

    @* Filtros (partial reutilizable) *@
    <partial name="_CatalogoFiltros" model="Model" />

    @* Tabla de productos (partial reutilizable) *@
    <partial name="_CatalogoTablaProductos" model="Model" />

    @* Offcanvas de acciones masivas (solo para roles autorizados) *@
    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Gerente"))
    {
        <partial name="_CatalogoAccionesMasivasOffcanvas" />
    }

    @* Offcanvas de Historial de Cambios de Precios *@
    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Gerente") || User.HasClaim("Permission", "precios:view"))
    {
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasHistorialPrecios" aria-labelledby="offcanvasHistorialPreciosLabel" style="width: 550px;">
            <div class="offcanvas-header bg-dark border-bottom border-secondary">
                <h5 class="offcanvas-title" id="offcanvasHistorialPreciosLabel">
                    <i class="bi bi-clock-history me-2 text-info"></i>Historial de Cambios de Precios
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
            </div>
            <div class="offcanvas-body bg-dark p-0">
                @* Loading *@
                <div id="historialLoading" class="d-flex justify-content-center align-items-center py-5">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>

                @* Error *@
                <div id="historialError" class="alert alert-danger m-3 d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="historialErrorMsg">Error al cargar el historial</span>
                </div>

                @* Contenido *@
                <div id="historialContenido" class="d-none">
                    @* Filtros del historial *@
                    <div class="px-3 py-2 border-bottom border-secondary bg-secondary bg-opacity-25">
                        <div class="d-flex gap-2 align-items-center">
                            <span class="text-light small">Mostrando últimos</span>
                            <select id="historialTake" class="form-select form-select-sm bg-dark text-light border-secondary" style="width: auto;">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                            </select>
                            <span class="text-light small">cambios</span>
                            <button type="button" class="btn btn-sm btn-outline-info ms-auto" id="btnRefreshHistorial">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    @* Tabla de historial *@
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-sm mb-0" id="tablaHistorialPrecios">
                            <thead class="table-secondary">
                                <tr>
                                    <th class="small">Fecha</th>
                                    <th class="small">Cambio</th>
                                    <th class="small text-center">Productos</th>
                                    <th class="small text-center">Estado</th>
                                    <th class="small text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historialTbody">
                                @* Se llena por JS *@
                            </tbody>
                        </table>
                    </div>

                    @* Empty state *@
                    <div id="historialEmpty" class="text-center py-5 d-none">
                        <i class="bi bi-inbox text-secondary fs-1"></i>
                        <p class="text-secondary mt-2">No hay cambios de precios registrados</p>
                    </div>
                </div>
            </div>
            <div class="offcanvas-footer bg-dark border-top border-secondary p-3">
                <a asp-controller="CambiosPrecios" asp-action="Index" class="btn btn-outline-light w-100">
                    <i class="bi bi-list-ul me-2"></i>Ver historial completo
                </a>
            </div>
        </div>

        @* Modal de confirmación de reversión *@
        <div class="modal fade" id="modalRevertirPrecio" tabindex="-1" aria-labelledby="modalRevertirPrecioLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header bg-danger text-white border-0">
                        <h5 class="modal-title" id="modalRevertirPrecioLabel">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>Revertir Cambio de Precios
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger small mb-3">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>¿Está seguro de revertir este cambio?</strong>
                            <p class="mb-0 mt-1">Esta acción restaurará los precios anteriores para todos los productos afectados.</p>
                        </div>

                        @* Datos del batch *@
                        <div id="revertirBatchInfo" class="mb-3">
                            <dl class="row small mb-0">
                                <dt class="col-5 text-muted">Nombre:</dt>
                                <dd class="col-7" id="revertirNombre">-</dd>

                                <dt class="col-5 text-muted">Cambio:</dt>
                                <dd class="col-7" id="revertirCambio">-</dd>

                                <dt class="col-5 text-muted">Productos afectados:</dt>
                                <dd class="col-7"><span class="badge bg-primary" id="revertirCantidad">0</span></dd>

                                <dt class="col-5 text-muted">Aplicado por:</dt>
                                <dd class="col-7" id="revertirAplicadoPor">-</dd>

                                <dt class="col-5 text-muted">Fecha aplicación:</dt>
                                <dd class="col-7" id="revertirFecha">-</dd>
                            </dl>
                        </div>

                        <hr class="my-3 border-secondary" />

                        @* Motivo de la reversión *@
                        <div class="mb-0">
                            <label for="revertirMotivo" class="form-label small fw-semibold">
                                Motivo de la reversión <span class="text-danger">*</span>
                            </label>
                            <textarea id="revertirMotivo" class="form-control bg-dark text-light border-secondary" 
                                      rows="3" maxlength="500" 
                                      placeholder="Ej: Error en el cálculo del porcentaje, cliente solicitó mantener precios anteriores..."></textarea>
                            <div class="form-text text-muted small">Máximo 500 caracteres</div>
                        </div>

                        @* Hidden fields *@
                        <input type="hidden" id="revertirBatchId" value="" />
                        <input type="hidden" id="revertirRowVersion" value="" />

                        @* Error message *@
                        <div id="revertirError" class="alert alert-danger mt-3 d-none small"></div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-danger" id="btnConfirmarReversion">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            <span id="btnRevertirTexto">Revertir Cambio</span>
                            <span id="btnRevertirLoading" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

</section>

@* Token antiforgery para llamadas AJAX *@
@Html.AntiForgeryToken()

@section Scripts {
    <!-- Script de selección de productos (disponible para todos) -->
    <script src="~/js/catalogo-seleccion.js"></script>
    
    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Gerente"))
    {
        <script src="~/js/catalogo-acciones-masivas.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Inicializar módulo de acciones masivas con datos del ViewModel
                CatalogoAcciones.init({
                    antiForgeryToken: '@Html.AntiForgeryToken()',
                    listasPrecios: @Html.Raw(Json.Serialize(Model.ListasPrecios.Select(l => new { id = l.Id, nombre = l.Nombre }))),
                    categorias: @Html.Raw(Json.Serialize(Model.Categorias.Select(c => new { id = c.Id, nombre = c.Nombre }))),
                    marcas: @Html.Raw(Json.Serialize(Model.Marcas.Select(m => new { id = m.Id, nombre = m.Nombre })))
                });
            });
        </script>
    }

    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Gerente") || User.HasClaim("Permission", "precios:view"))
    {
        <script>
            // Módulo de Historial de Cambios de Precios con Rollback integrado
            const HistorialPrecios = (function() {
                'use strict';

                const elementos = {};
                let modalRevertir = null;

                function init() {
                    elementos.offcanvas = document.getElementById('offcanvasHistorialPrecios');
                    elementos.loading = document.getElementById('historialLoading');
                    elementos.error = document.getElementById('historialError');
                    elementos.errorMsg = document.getElementById('historialErrorMsg');
                    elementos.contenido = document.getElementById('historialContenido');
                    elementos.tbody = document.getElementById('historialTbody');
                    elementos.empty = document.getElementById('historialEmpty');
                    elementos.selectTake = document.getElementById('historialTake');
                    elementos.btnRefresh = document.getElementById('btnRefreshHistorial');
                    elementos.btnHistorialRapido = document.getElementById('btnHistorialRapido');

                    // Elementos del modal de reversión
                    elementos.modalRevertir = document.getElementById('modalRevertirPrecio');
                    elementos.revertirBatchId = document.getElementById('revertirBatchId');
                    elementos.revertirRowVersion = document.getElementById('revertirRowVersion');
                    elementos.revertirNombre = document.getElementById('revertirNombre');
                    elementos.revertirCambio = document.getElementById('revertirCambio');
                    elementos.revertirCantidad = document.getElementById('revertirCantidad');
                    elementos.revertirAplicadoPor = document.getElementById('revertirAplicadoPor');
                    elementos.revertirFecha = document.getElementById('revertirFecha');
                    elementos.revertirMotivo = document.getElementById('revertirMotivo');
                    elementos.revertirError = document.getElementById('revertirError');
                    elementos.btnConfirmarReversion = document.getElementById('btnConfirmarReversion');
                    elementos.btnRevertirTexto = document.getElementById('btnRevertirTexto');
                    elementos.btnRevertirLoading = document.getElementById('btnRevertirLoading');

                    if (!elementos.offcanvas) return;

                    // Inicializar modal
                    if (elementos.modalRevertir) {
                        modalRevertir = new bootstrap.Modal(elementos.modalRevertir);
                        
                        // Limpiar al cerrar
                        elementos.modalRevertir.addEventListener('hidden.bs.modal', limpiarModalRevertir);
                        
                        // Confirmar reversión
                        elementos.btnConfirmarReversion?.addEventListener('click', ejecutarReversion);
                    }

                    // Eventos del offcanvas
                    elementos.offcanvas.addEventListener('show.bs.offcanvas', cargarHistorial);
                    elementos.selectTake?.addEventListener('change', cargarHistorial);
                    elementos.btnRefresh?.addEventListener('click', cargarHistorial);

                    // Vincular botón de historial rápido de la barra sticky
                    elementos.btnHistorialRapido?.addEventListener('click', abrirHistorial);

                    console.log('[HistorialPrecios] Inicializado con soporte de Rollback');
                }

                function abrirHistorial() {
                    const offcanvas = new bootstrap.Offcanvas(elementos.offcanvas);
                    offcanvas.show();
                }

                async function cargarHistorial() {
                    mostrarLoading(true);

                    const take = elementos.selectTake?.value || 20;

                    try {
                        const response = await fetch(`/CambiosPrecios/HistorialApi?take=${take}`);
                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'Error desconocido');
                        }

                        renderizarHistorial(data.historial);
                    } catch (error) {
                        mostrarError(error.message);
                    }
                }

                function renderizarHistorial(historial) {
                    elementos.loading.classList.add('d-none');
                    elementos.error.classList.add('d-none');
                    elementos.contenido.classList.remove('d-none');

                    if (!historial || historial.length === 0) {
                        elementos.empty.classList.remove('d-none');
                        elementos.tbody.innerHTML = '';
                        return;
                    }

                    elementos.empty.classList.add('d-none');

                    const html = historial.map(item => `
                        <tr>
                            <td class="small">
                                <div>${item.fecha}</div>
                                <div class="text-muted small">${item.usuario}</div>
                            </td>
                            <td>
                                <span class="fw-semibold ${item.tipoAplicacion === 'Aumento' ? 'text-success' : 'text-danger'}">
                                    ${item.cambioDisplay}
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-secondary">${item.cantidadProductos}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge ${item.estadoBadgeClass}">${item.estado}</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <a href="${item.previewUrl}" class="btn btn-outline-info btn-sm" title="Ver detalle">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    ${item.puedeRevertir ? `
                                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                                onclick="HistorialPrecios.abrirModalRevertir(${item.id})"
                                                title="Revertir">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');

                    elementos.tbody.innerHTML = html;
                }

                function mostrarLoading(show) {
                    elementos.loading.classList.toggle('d-none', !show);
                    elementos.contenido.classList.add('d-none');
                    elementos.error.classList.add('d-none');
                }

                function mostrarError(mensaje) {
                    elementos.loading.classList.add('d-none');
                    elementos.contenido.classList.add('d-none');
                    elementos.error.classList.remove('d-none');
                    elementos.errorMsg.textContent = mensaje;
                }

                // =============================================
                // ROLLBACK FUNCTIONS
                // =============================================

                async function abrirModalRevertir(batchId) {
                    if (!modalRevertir) return;

                    // Mostrar modal con loading
                    elementos.revertirNombre.textContent = 'Cargando...';
                    elementos.revertirCambio.textContent = '-';
                    elementos.revertirCantidad.textContent = '-';
                    elementos.revertirAplicadoPor.textContent = '-';
                    elementos.revertirFecha.textContent = '-';
                    elementos.revertirError.classList.add('d-none');
                    
                    modalRevertir.show();

                    try {
                        const response = await fetch(`/CambiosPrecios/GetBatchParaRevertirApi?id=${batchId}`);
                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'Error al cargar datos');
                        }

                        // Llenar datos del batch
                        const batch = data.batch;
                        elementos.revertirBatchId.value = batch.id;
                        elementos.revertirRowVersion.value = batch.rowVersion;
                        elementos.revertirNombre.textContent = batch.nombre;
                        elementos.revertirCambio.innerHTML = `<span class="fw-semibold">${batch.cambioDisplay}</span>`;
                        elementos.revertirCantidad.textContent = batch.cantidadProductos;
                        elementos.revertirAplicadoPor.textContent = batch.aplicadoPor || '-';
                        elementos.revertirFecha.textContent = batch.fechaAplicacion || '-';

                    } catch (error) {
                        elementos.revertirError.textContent = error.message;
                        elementos.revertirError.classList.remove('d-none');
                    }
                }

                function limpiarModalRevertir() {
                    elementos.revertirBatchId.value = '';
                    elementos.revertirRowVersion.value = '';
                    elementos.revertirMotivo.value = '';
                    elementos.revertirError.classList.add('d-none');
                    setLoadingRevertir(false);
                }

                async function ejecutarReversion() {
                    const batchId = parseInt(elementos.revertirBatchId.value);
                    const rowVersion = elementos.revertirRowVersion.value;
                    const motivo = elementos.revertirMotivo.value.trim();

                    // Validar motivo
                    if (!motivo) {
                        elementos.revertirError.textContent = 'Debe especificar un motivo para la reversión';
                        elementos.revertirError.classList.remove('d-none');
                        elementos.revertirMotivo.focus();
                        return;
                    }

                    if (motivo.length < 10) {
                        elementos.revertirError.textContent = 'El motivo debe tener al menos 10 caracteres';
                        elementos.revertirError.classList.remove('d-none');
                        elementos.revertirMotivo.focus();
                        return;
                    }

                    setLoadingRevertir(true);
                    elementos.revertirError.classList.add('d-none');

                    try {
                        // Obtener token CSRF
                        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                        const response = await fetch('/CambiosPrecios/RevertirApi', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': token || ''
                            },
                            body: JSON.stringify({
                                batchId: batchId,
                                rowVersion: rowVersion,
                                motivo: motivo
                            })
                        });

                        const data = await response.json();

                        if (!response.ok || !data.success) {
                            throw new Error(data.error || 'Error al revertir');
                        }

                        // Éxito - cerrar modal y recargar historial
                        modalRevertir.hide();
                        
                        // Mostrar toast de éxito
                        mostrarToast('success', data.mensaje || 'Cambio revertido exitosamente');
                        
                        // Recargar historial
                        cargarHistorial();

                    } catch (error) {
                        elementos.revertirError.textContent = error.message;
                        elementos.revertirError.classList.remove('d-none');
                        setLoadingRevertir(false);
                    }
                }

                function setLoadingRevertir(loading) {
                    elementos.btnConfirmarReversion.disabled = loading;
                    elementos.btnRevertirTexto.classList.toggle('d-none', loading);
                    elementos.btnRevertirLoading.classList.toggle('d-none', !loading);
                }

                function mostrarToast(tipo, mensaje) {
                    // Usar toast global si existe, o alert como fallback
                    if (window.showToast) {
                        window.showToast(tipo, mensaje);
                    } else {
                        alert(mensaje);
                    }
                }

                // Exponer para uso desde onclick
                return {
                    init,
                    abrirHistorial,
                    cargarHistorial,
                    abrirModalRevertir
                };
            })();

            document.addEventListener('DOMContentLoaded', function() {
                HistorialPrecios.init();
            });
        </script>
    }
}

