@model TheBuryProject.ViewModels.CatalogoUnificadoViewModel

@{
    ViewData["Title"] = "Catálogo";
    var returnUrl = Context.Request.Path + Context.Request.QueryString;

    // UNA sola verdad para permisos (UI + modals + scripts)
    var puedeEditarPrecios =
        User.IsInRole("SuperAdmin") || User.IsInRole("Gerente") ||
        User.HasClaim("Permission", "precios:apply");

    var puedeVerHistorial =
        User.IsInRole("SuperAdmin") || User.IsInRole("Gerente") ||
        User.HasClaim("Permission", "precios:view");
}

<section class="container-fluid py-4">

    <partial name="_Alerts" />
    <partial name="_CatalogoFiltros" model="Model" />
    <partial name="_CatalogoTablaProductos" model="Model" />

</section>

@Html.AntiForgeryToken()

@section Modals
{
    @* Modal/acciones masivas (Actualizar precios) *@
    @if (puedeEditarPrecios)
    {
        <partial name="_CatalogoAccionesMasivasOffcanvas" />
        <partial name="_CatalogoModalConfirmarAplicar" />
    }

    @* Offcanvas historial: puede verlo quien tenga permiso de view *@
    @if (puedeVerHistorial)
    {
        <partial name="_CatalogoHistorialPreciosOffcanvas" />
    }

    @* Modal de revertir: SOLO quien puede editar/revertir (no solo ver) *@
    @if (puedeEditarPrecios)
    {
        <partial name="_CatalogoModalRevertirPrecio" />
    }
}

@section Scripts
{
    <script id="catalogo-init" type="application/json">
        @Html.Raw(Json.Serialize(new
        {
            esAdminPrecios = puedeEditarPrecios,
            puedeVerHistorial = puedeVerHistorial,
            listasPrecios = Model.ListasPrecios.Select(l => new { id = l.Id, nombre = l.Nombre }),
            listaPrecioActualId = Model.ListaPrecioId,
            categorias = Model.Categorias.Select(c => new { id = c.Id, nombre = c.Nombre }),
            marcas = Model.Marcas.Select(m => new { id = m.Id, nombre = m.Nombre })
        }))
    </script>

    @if (puedeEditarPrecios)
    {
        <script src="~/js/catalogo-acciones-masivas-directo.js" asp-append-version="true"></script>
    }

    @if (puedeVerHistorial)
    {
        <script src="~/js/catalogo-historial-precios.js" asp-append-version="true"></script>
    }
}
